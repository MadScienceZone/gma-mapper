'\" t
'\" *** 418 ***
'\" <<ital-is-var>>
.TH GMA-MAPPER-PROTOCOL 7 "GMA-Mapper 4.30.2" 24-May-2025 "Protocols" \" @@mp@@
.SH NAME
gma-mapper-protocol \- GMA client/server protocol specification
'\" <<New>>
.SH EXPERIMENTAL
.LP
.B "This document includes experimental changes to the protocol which have not yet been officially released."
'\" <<bold-is-fixed>>
'\" <</New>>
.SH DESCRIPTION
.LP
The
.BR mapper (6)
program displays a battle grid map for the players to see their tactical positions
with respect to their opponents and features of their environment (e.g., dungeon
rooms). To take advantage of its full multi-user capabilities, multiple
.B mapper
clients may be connected to the GMA
.BR server (6).
The following document is the definitive specification describing the protocol used to communicate all messages
between these programs (as well as others which interact with the GMA server,
such as
.BR gma-console (6)).
.LP
When a client is connected to a GMA server, they exchange
commands to indicate changes to the map display or other game state information.
To help keep communications simple and to help clients
recover from malformed or missing data, each
command is a newline-terminated line of text
as described in detail below.  If the mapper sends one of these
commands to the service, it is indicating that the local
user made those changes and requests that other connected
map clients update themselves accordingly.  If the mapper receives
the command from the service, it should comply to make the
corresponding change to itself.
.LP
The key words \*(lqMUST\*(rq, \*(lqMUST NOT\*(rq, \*(lqREQUIRED\*(rq, \*(lqSHALL\*(rq, \*(lqSHALL
NOT\*(rq, \*(lqSHOULD\*(rq, \*(lqSHOULD NOT\*(rq, \*(lqRECOMMENDED\*(rq,  \*(lqMAY\*(rq, and
\*(lqOPTIONAL\*(rq in this document are to be interpreted as described in
RFC 2119.
.LP
The software implementing this protocol
MUST 
allow Unicode text encoded as UTF-8
everywhere (of which 7-bit ASCII is a subset).
.LP
Each command (sent or received) consists of a command word
followed by a JSON object holding the parameters appropriate to
that command. (See the description of the 
.B //
command for an exception to this rule.)
.LP
The JSON object MAY be omitted (particularly if
the command in question has no parameters). Any expected parameter fields
which do not appear in the JSON object are automatically assumed to have
an appropriate \*(lqzero\*(rq value (i.e., empty string, zero numeric
value, empty list, boolean false, etc.). Any fields sent which were not expected by the receiver are silently
ignored.
.LP
JSON field names are matched case-sensitively. A client 
MAY 
match names
regardless of case but 
MUST 
emit them as documented here.
.LP
Field values are strings unless otherwise noted.
.LP
Unless otherwise noted, there is no response expected from
these commands. Even where a response is expected, it will be
asynchronously sent. In any case the client 
SHOULD NOT
wait for a server
response before considering its request to be completed. As a special
case, a client 
MAY 
be implemented to wait synchronously for a server
response during the authentication negotiation stage.
.LP
'\" <</bold-is-fixed>>
.B "This describes protocol version 418."
'\" <<bold-is-fixed>>
These notes are intended to be 
detailed enough to implement a client from and should be considered
the definitive standard reference to the protocol.
.LP
In the protocol command descriptions,
'\" <<TeX>>
'\" {\ttfamily fixed-width}
.B BOLD
'\" <</TeX>>
text indicates literal text to be sent as-is,
.I Italics
indicate a parameter whose value should appear in place of the name shown, and
[square brackets]
surround optional items which may be omitted.
.LP
The normal course of actions at the start of the conversation is for the server to immediately send an initial
greeting beginning with a
.B PROTOCOL
command followed by comments, 
.BR AC , 
.BR DSM , 
.BR UPDATES ,
and/or
.BR WORLD 
commands, then send an 
.B OK
command to indicate to the client its protocol version and to issue an
authentication challenge (if configured to authenticate). It is 
RECOMMENDED
that the initial greeting be limited only to comments, waiting until after authentication
to send anything more specific about your game.
.LP
After the
.B OK
command, the client responds with an
.B AUTH
command if it is required to authenticate. The server will respond with
.B GRANTED
or
.B DENIED
and then 
MAY 
issue more of the initial greeting commands listed above.
.LP
Finally, the server will issue a
.B READY
command to the client and begin normal interaction with the client.
.LP
The server 
MUST NOT
send the
.BR AC ,
.BR GRANTED ,
.BR OK ,
.BR READY ,
.BR UPDATES ,
or
.BR WORLD
commands after the initial
.B READY
is sent.
Clients MUST NOT send the
.BR AUTH 
command after receiving the server's
.B READY
signal.
(Note that prior to protocol 414, servers were not allowed to send
.B DENIED
to clients after the
.B READY
message. Now they can send a
.B DENIED
message at any time to indicate that they wish to terminate the
client's session immediately.)
.SS "Command Summary"
.LP
'\"<<TeX>>
The messages sent by clients and servers is summarized in the following table
and then explained in detail in the following paragraphs.
In the table, Message is the standard message name recommended for identifier names
in source code, Command is the string actually sent over the network, C\[<>]S indicates
whether the message is only sent from client to server, only from server to client, or
if it could be sent in either direction. Priv indicates if the command may only be
sent by a client authenticated as the GM.
Note that Reply indicates the command which
SHOULD
(eventually) arrive in response, but no guarantee is made as to if or when that happens
since all communications are asynchronous.
'\"The messages sent by clients and servers is summarized in Tables~\ref{tbl:mapper:6:messages}
'\"and \ref{tbl:mapper:6:messages2},
'\"and then explained in detail in the following paragraphs.
'\"In the table, 
'\"Command is the string actually sent over the network, C$\leftrightarrow$S indicates
'\"whether the message is only sent from client to server, only from server to client, or
'\"if it could be sent in either direction. Priv indicates if the command may only be
'\"sent by a client authenticated as the \gm.
'\"Note that Reply indicates the command which \mc{SHOULD}
'\"(eventually) arrive in response, but no guarantee is made as to if or when that happens
'\"since all communications are asynchronous.
'\"\begin{table}
'\" \begin{tabular}{lcllll}\toprule
'\"  {\bfseries Command}&{\bfseries C$\leftrightarrow$S}&{\bfseries Reply}&{\bfseries Priv}&{\bfseries Data}&{\bfseries Description}\\\midrule
'\"  \z{//}     &C$\leftrightarrow$S&---        &no &any           &Human-readable comment\\
'\"  \z{/CONN}  &C$\rightarrow$S    &\z{CONN}   &no &none          &Request list of peer clients\\
'\"  \z{ACCEPT} &C$\rightarrow$S    &---        &no &\acronym{JSON}&Subscribe to a set of messages\\
'\"  \z{AC}     &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Add primary PC to party\\
'\"  \z{ALLOW}  &C$\rightarrow$S    &---        &no &\acronym{JSON}&Indicate supported features\\
'\"  \z{AUTH}   &C$\rightarrow$S    &\z{GRANTED}&no &\acronym{JSON}&Authenticate to server\\
'\"  \z{AV}     &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Scroll clients' views\\
'\"  \z{AI}     &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add image to client's known set\\
'\"  \z{AI?}    &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Ask for definition of image\\
'\"  \z{AI/}    &C$\rightarrow$S    &---        &yes&\acronym{JSON}&Filter saved image definitions\\
'\"  \z{CC}     &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Clear the chat history\\
'\"  \z{CLR}    &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Remove objects from client\\
'\"  \z{CLR@}   &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Remove elements from a map file\\
'\"  \z{CO}     &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Turn on/off combat mode\\
'\"  \z{CONN}   &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Notify of all connected peers\\
'\"  \z{CORE}   &C$\rightarrow$S    &\z{CORE=}  &no &\acronym{JSON}&Query the core game database\\
'\"  \z{CORE=}  &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Core game data from the game database\\
'\"  \z{CORE/}  &C$\rightarrow$S    &---        &yes&\acronym{JSON}&Filter availability of the game database\\
'\"  \z{COREIDX}&C$\rightarrow$S    &\z{COREIDX=}&no&\acronym{JSON}&Get core database index\\
'\"  \z{COREIDX=}&C$\leftarrow$S    &---        &N/A&\acronym{JSON}&Update core database index info\\
'\"  \z{CS}     &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Change the current time of day\\
'\"  \z{D}      &C$\rightarrow$S    &\z{ROLL}   &no &\acronym{JSON}&Initiate a die roll\\
'\"  \z{DD}     &C$\leftarrow$S     &\z{DD=}    &maybe&\acronym{JSON}&Store new presets for user\\
'\"  \z{DD+}    &C$\rightarrow$S    &\z{DD=}    &maybe&\acronym{JSON}&Add presets to user's set\\
'\"  \z{DD/}    &C$\rightarrow$S    &\z{DD=}    &maybe&\acronym{JSON}&Filter user's presets\\
'\"  \z{DD=}    &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Receive user's presets\\
'\"  \z{DDD}    &C$\rightarrow$S    &\z{DD=}    &maybe&\acronym{JSON}&Define preset delegates\\
'\"  \z{DENIED} &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Server denies access\\
'\"  \z{DR}     &C$\rightarrow$S    &\z{DD=}    &maybe&\acronym{JSON}&Request user's presets\\
'\"  \z{DSM}    &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Define creature status marker\\
'\"  \z{ECHO}   &C$\leftrightarrow$S&\z{ECHO}   &no &\acronym{JSON}&Send data for server to echo back\\
'\"  \z{FAILED} &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Request failed or denied by GM\\
'\"  \z{GRANTED}&C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Server grants access\\
'\"  \z{HPACK}  &C$\leftrightarrow$S&---	&yes&\acronym{JSON}&Acknowledge hit point request\\
'\"  \z{HPREQ}  &C$\leftrightarrow$S&\z{HPACK}/\z{FAILED}&no&\acronym{JSON}&Request hit point change\\
'\"  \z{I}      &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Indicate turn in combat\\
'\"  \z{IL}     &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Update the initiative list\\
'\"  \z{L}      &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Load elements from file\\
'\"  \z{LS-ARC} &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add an arc to the map\\
'\"  \z{LS-CIRC}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add an ellipse to the map\\
'\"  \z{LS-LINE}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add a line to the map\\
'\"  \z{LS-POLY}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add a polygon to the map\\
'\"  \z{LS-RECT}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add a rectangle to the map\\
'\"  \z{LS-SAOE}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add an area of effect to the map\\
'\"  \z{LS-TEXT}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add some text to the map\\
'\"  \z{LS-TILE}&C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add a graphic tile to the map\\
'\"  \z{MARCO}  &C$\leftarrow$S     &\z{POLO}   &N/A&none          &Check if client is alive\\
'\" \end{tabular}
'\" \caption{Summary of Client/Server Messages}\label{tbl:mapper:6:messages}
'\"\end{table}
'\"\begin{table}
'\" \begin{tabular}{lcllll}\toprule
'\"  {\bfseries Command}&{\bfseries C$\leftrightarrow$S}&{\bfseries Reply}&{\bfseries Priv}&{\bfseries Data}&{\bfseries Description}\\\midrule
'\"  \z{MARK}   &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Visually mark a spot\\\bottomrule
'\"  \z{POLO}   &C$\rightarrow$S    &---        &no &none          &Acknowledge server's ping\\
'\"  \z{PRIV}   &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Privileged command denied\\
'\"  \z{PROGRESS}&C$\leftrightarrow$S&---       &no &\acronym{JSON}&Indicate progress on task\\
'\"  \z{PROTOCOL}&C$\leftarrow$S    &---        &N/A&int           &Signal protocol version in use\\
'\"  \z{PS}     &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Place a creature token\\
'\"  \z{READY}  &C$\leftarrow$S     &---        &N/A&none          &Server sign-on complete\\
'\"  \z{REDIRECT}&C$\leftarrow$S    &---        &N/A&\acronym{JSON}&Instruct client to use a different server\\
'\"  \z{ROLL}   &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Result of a die roll\\
'\"  \z{OA}     &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Update object attributes\\
'\"  \z{OA+}    &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Add values to an attribute\\
'\"  \z{OA-}    &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Remove values to an attribute\\
'\"  \z{OK}     &C$\leftarrow$S     &\z{AUTH}   &N/A&\acronym{JSON}&Ask client to authenticate\\
'\"  \z{SYNC}   &C$\rightarrow$S    &any        &no &none          &Request replay of commands\\
'\"  \z{SYNC-CHAT}&C$\rightarrow$S  &\z{CC}/\z{ROLL}/\z{TO}&no&\acronym{JSON}&Request replay of messages\\
'\"  \z{TB}     &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Turn on/off client toolbar\\
'\"  \z{TMACK}  &C$\leftrightarrow$S&---        &yes&\acronym{JSON}&Acknowledge a timer request\\
'\"  \z{TMRQ}   &C$\leftrightarrow$S&\z{TMACK}/\z{FAILED}&no&\acronym{JSON}&Request a timer\\
'\"  \z{TO}     &C$\leftrightarrow$S&---        &no &\acronym{JSON}&Send chat message\\
'\"  \z{UPDATES}&C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Advertise software updates\\
'\"  \z{WORLD}  &C$\leftarrow$S     &---        &N/A&\acronym{JSON}&Campaign world info\\\bottomrule
'\" \end{tabular}
'\" \caption{Summary of Client/Server Messages (continued)}\label{tbl:mapper:6:messages2}
'\"\end{table}
.LP
.TS
center;
lB lB cB lB lB lB lB
l lfC c lfC c c l.
Message	Command	C\[<>]S	Reply	Priv	Payload	Description
Accept	ACCEPT	C\[->]S	\fR\(em\fP	no	JSON	Subscribe to a set of messages
AddCharacter	AC	C\[<-]S	\fR\(em\fP	N/A	JSON	Add primary PC to party
AddDicePresets	DD+	C\[->]S	DD=	no	JSON	Add presets to user's set
AddImage	AI	C\[<>]S	\fR\(em\fP	no	JSON	Add image to client's known set
AddObjAttributes	OA+	C\[<>]S	\fR\(em\fP	no	JSON	Add values to an attribute
AdjustView	AV	C\[<>]S	\fR\(em\fP	no	JSON	Scroll clients' views
Allow	ALLOW	C\[->]S	\fR\(em\fP	no	JSON	Indicate supported features
Auth	AUTH	C\[->]S	GRANTED	no	JSON	Authenticate to server
Challenge	OK	C\[<-]S	AUTH	N/A	JSON	Ask client to authenticate
ChatMessage	TO	C\[<>]S	\fR\(em\fP	no	JSON	Send chat message
Clear	CLR	C\[<>]S	\fR\(em\fP	no	JSON	Remove objects from client
ClearChat	CC	C\[<>]S	\fR\(em\fP	no	JSON	Clear the chat history
ClearFrom	CLR@	C\[<>]S	\fR\(em\fP	no	JSON	Remove elements from a map file
CombatMode	CO	C\[<>]S	\fR\(em\fP	yes	JSON	Turn on/off combat mode
Comment	//	C\[<>]S	\fR\(em\fP	no	any	Human-readable comment
DefineDicePresets	DD	C\[->]S	DD=	maybe	JSON	Store new presets for user
DefineDiceDelegates	DDD	C\[->]S	DD=	maybe	JSON	Assign die-roll delegates
Denied	DENIED	C\[<-]S	\fR\(em\fP	N/A	JSON	Server denies access
Echo	ECHO	C\[<>]S	ECHO	no	JSON	Send data for server to echo back to client
Failed	FAILED	C\[<>]S	\fR\(em\fP	yes	JSON	Request failed or denied by GM
FilterCoreData	CORE/	C\[->]S	\fR\(em\fP	yes	JSON	Filter availability of the game database
FilterDicePresets	DD/	C\[->]S	DD=	maybe	JSON	Remove some presets for user
FilterImages	AI/	C\[->]S	\fR\(em\fP	yes	JSON	Filter saved image definitions
Granted	GRANTED	C\[<-]S	\fR\(em\fP	N/A	JSON	Server grants access
HitPontAcknowledge	HPACK	C\[<>]S	\fR\(em\fP	yes	JSON	Acknowledge hit point update request
HitPointRequest	HPREQ	C\[<>]S	FAILED	no	JSON	Request change in hit points
\^	\^	\^	HPACK	\^	\^	\^
LoadArcObject	LS-ARC	C\[<>]S	\fR\(em\fP	no	JSON	Add an arc to the map
LoadCircleObject	LS-CIRC	C\[<>]S	\fR\(em\fP	no	JSON	Add an ellipse to the map
LoadFrom	L	C\[<>]S	\fR\(em\fP	no	JSON	Load elements from file
LoadLineObject	LS-LINE	C\[<>]S	\fR\(em\fP	no	JSON	Add a line to the map
LoadPolygonObject	LS-POLY	C\[<>]S	\fR\(em\fP	no	JSON	Add a polygon to the map
LoadRectangleObject	LS-RECT	C\[<>]S	\fR\(em\fP	no	JSON	Add a rectangle to the map
LoadSpellArea\fR-\fP	LS-SAOE	C\[<>]S	\fR\(em\fP	no	JSON	Add an area of effect to the map
\ OfEffectObject	\^	\^	\^	\^	\^	\^
LoadTextObject	LS-TEXT	C\[<>]S	\fR\(em\fP	no	JSON	Add some text to the map
LoadTileObject	LS-TILE	C\[<>]S	\fR\(em\fP	no	JSON	Add a graphic tile to the map
Marco	MARCO	C\[<-]S	POLO	N/A	none	Check if client is alive
Mark	MARK	C\[<>]S	\fR\(em\fP	no	JSON	Visually mark a spot
PlaceSomeone	PS	C\[<>]S	\fR\(em\fP	no	JSON	Place creature token
Polo	POLO	C\[->]S	\fR\(em\fP	no	none	Acknowledge server's ping
Priv	PRIV	C\[<-]S	\fR\(em\fP	N/A	JSON	Priveleged command denied
Protocol	PROTOCOL	C\[<-]S	\fR\(em\fP	N/A	int	Signal protocol version in use
QueryCoreData	CORE	C\[->]S	CORE=	no	JSON	Query the core game database
QueryCoreIndex	COREIDX	C\[->]S	COREIDX=	no	JSON	Query the core database index
QueryDicePresets	DR	C\[->]S	DD=	maybe	JSON	Request user's presets
QueryImage	AI?	C\[<>]S	AI	no	JSON	Ask for definition of image
QueryPeers	/CONN	C\[->]S	CONN	no	none	Request list of peer clients
Ready	READY	C\[<-]S	\fR\(em\fP	N/A	none	Server sign-on complete
Redirect	REDIRECT	C\[<-]S	\fR\(em\fP	N/A	JSON	Instruct client to use a different server
RemoveObjAttributes	OA-	C\[<>]S	\fR\(em\fP	no	JSON	Remove values from an attribute
RollDice	D	C\[->]S	ROLL	no	JSON	Initiate a die roll
RollResult	ROLL	C\[<-]S	\fR\(em\fP	N/A	JSON	Result of a die roll
Sync	SYNC	C\[->]S	\fRany\fP	no	none	Request replay of commands
SyncChat	SYNC-CHAT	C\[->]S	CC	no	JSON	Request replay of messages
\^	\^	\^	ROLL	\^	\^	\^
\^	\^	\^	TO	\^	\^	\^
TimerAcknowledge	TMACK	C\[<>]S	\fR\(em\fP	yes	JSON	Acknowledge timer request
TimerRequest	TMRQ	C\[<>]S	FAILED	no	JSON	Request a new timer
\^	\^	\^	TMACK	\^	\^	\^
\^	\^	\^	PROGRESS	\^	\^	\^
Toolbar	TB	C\[<>]S	\fR\(em\fP	yes	JSON	Turn on/off client toolbar
UpdateClock	CS	C\[<>]S	\fR\(em\fP	yes	JSON	Change the current time of day
UpdateCoreData	CORE=	C\[<-]S	\fR\(em\fP	N/A	JSON	Update a core data item
UpdateCoreIndex	COREIDX=	C\[<-]S	\fR\(em\fP	N/A	JSON	Update core data index
UpdateDicePresets	DD=	C\[<-]S	\fR\(em\fP	N/A	JSON	Receive user's presets
UpdateInitiative	IL	C\[<>]S	\fR\(em\fP	yes	JSON	Update the initiative list
UpdateObjAttributes	OA	C\[<>]S	\fR\(em\fP	no	JSON	Update object attributes
UpdatePeerList	CONN	C\[<-]S	\fR\(em\fP	N/A	JSON	Notify of all connected peers
UpdateProgress	PROGRESS	C\[<>]S	\fR\(em\fP	no	JSON	Indicate progress on task
UpdateStatusMarker	DSM	C\[<>]S	\fR\(em\fP	yes	JSON	Define creature status marker
UpdateTurn	I	C\[<>]S	\fR\(em\fP	yes	JSON	Indicate turn in combat
UpdateVersions	UPDATES	C\[<-]S	\fR\(em\fP	N/A	JSON	Advertise software updates
World	WORLD	C\[<-]S	\fR\(em\fP	N/A	JSON	Campaign world info
.TE
'\"<</TeX>>
.SS "Command Details"
.LP
The client/server messages and their parameters are detailed below, ordered by the server
command string sent or received.
'\" <<list>>
.TP 12
.B //
This is a server comment.  The entire command SHOULD be ignored by all clients. This is used
to inject informative context and messages into the client/server conversation which may be
of interest for debugging or interactive use.
.RS
.LP
The mapper client will interpret a server comment beginning with the text
.RB \*(lq notice: \*(rq
which is received during the initial connection negotiation (i.e., before the
.B READY
message is given by the server) as a notice that the end user should see.
The text following the word
.RB \*(lq notice: \*(rq
is posted in an alert box. Clients MUST recognize the string in all lower-case
if they choose to implement this feature; they MAY also recognize it regardless
of case.
.LP
'\" <</ital-is-var>>
.I "This is one of two exceptions to the rule that a command contains a JSON parameter"
.I "object. In this case, the"
entire
.I "line should be ignored by the client and not interpreted further."
'\" <<ital-is-var>>
This allows, for example, comments to be sent at the start of the server's
signon message to provide a human-readable declaration as to the allowed
usage of the server.
.RE
.TP
.BI "PROTOCOL " v
This command (which\(emif used at all\(emMUST be the first command sent by 
the server to the client) 
gives an up-front indication to the client as to what protocol
version is expected by the server. Older versions of the server waited until
the
.B OK
command to notify the client, but as of protocol version 400 this is now too late
for the client to correctly process the commands that may be sent before the
.BR OK .
This, along with the 
.B //
server comment command, are the only two commands which do
'\" <</ital-is-var>>
.I not
'\" <<ital-is-var>>
have a JSON data payload attached to them. The protocol version number is
simply sent as an ASCII string of digits separated from the 
.B PROTOCOL
command word by a space.
The reason for this is that this data format is valid in all protocol
versions, including those before version 400, so it can be used to
unambiguously identify the server's protocol to all possible clients.
.RS
.LP
Servers which implement protocol versions 400 and later MUST send this message
at the start of their conversations. Servers which implement older protocol versions
SHOULD send it.
.RE
.TP
.B AC
Add a character to the pop-up menu for map clients. This makes it easy to place important character tokens
on the map and ensures that such tokens are given consistent
.I id
values rather than generating random ones.
Clients MUST NOT send this command to each other; it is intended for the server to send to the clients.
The payload includes the same fields as the
.B PS
command.
.TP
.B ACCEPT
A client sends this message to the server to indicate that from this point
forward (until another
.B ACCEPT
command), only the commands listed
should be sent to it by the server. 
The payload is a JSON object with this parameter:
'\" <<list>>
'\" <</ital-is-var>>
.RS
.TP 
.BI Messages " (list)"
'\" <<ital-is-var>>
A list of command names the client wishes to receive.
This is a list of command names as they
appear in this specification (e.g.,
.BR "[\[dq]AI\[dq],\[dq]CO\[dq],\[dq]TO\[dq]]" ).
If it contains the special value
.RB \*(lq * \*(rq
or is empty, this means to accept all messages. Note that the server may still
decide to send messages such as comments or the 
.B MARCO
command (or others) at its discretion despite this request from the client.
.RE
'\" <</>>
.TP
.B AI
Add an image to the map.
(Supersedes the function of the
.BR AI ,
.BR AI: ,
.BR AI. ,
and
.BR AI@
commands as of protocol version 400.)
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Animation " (object)"
'\" <<ital-is-var>>
If this value is given and non-null, this image is to be animated
from individual frames. If the client is capable of animating
multi-frame files, the base filename can be used directly. 
Servers offering this file SHOULD provide the multi-frame animated image file in
a variety of formats, and SHOULD provide single-frame files in all
formats in which they provide static images. 
.RS
.LP
Individual frame files are named by prefixing the base filename
with 
.RB \*(lq :\fIn\fP: \*(rq
where
.I n
is the frame number, starting with 0. The
.B Animation
object has the following fields:
'\" <<list>>
.TP
'\" <</ital-is-var>>
.BI Frames " (int)"
'\" <<ital-is-var>>
The number of frames in the animation.
.TP
'\" <</ital-is-var>>
.BI FrameSpeed " (int)"
'\" <<ital-is-var>>
The number of milliseconds to delay between frames.
.TP
'\" <</ital-is-var>>
.BI Loops " (int)"
'\" <<ital-is-var>>
If present and non-zero, the animation will play this many times before stopping. Otherwise,
the animation plays forever.
.RE
'\" <</>>
.TP
.B Name
The name of the image as known within the mapper.
.TP
'\" <</ital-is-var>>
.BI Sizes " (list of objects)"
A list of sizes available for this object. This will be
.I merged
'\" <<ital-is-var>>
with any previously defined sizes for the same image name.
Each element of this list is an object with the following fields:
'\" <<list>>
.RS
.TP
.B File
The filename or server ID by which the image can be retrieved.
.TP
'\" <</ital-is-var>>
.BI ImageData " (base64-encoded bytes)"
If non-empty or not
.BR null ,
this provides the raw image data. This is DEPRECATED but still supported.
Instead, images SHOULD be loaded to the game server and their ServerID used
by clients.
.TP
'\" <</ital-is-var>>
.BI IsLocalFile " (bool)"
'\" <<ital-is-var>>
If
.BR true ,
then
.B File
gives a local file pathname for the image; otherwise it gives the
server-specific ID which the client will use to retrieve the file
from the server.
.TP
'\" <</ital-is-var>>
.BI Zoom " (float)"
The magnification level this bitmap represents for the given
image. Typically images are provided for
'\" <<ital-is-var>>
zoom
levels of 0.25, 0.5, 1, 2, and 4.
'\" <</>>
.RE
'\" <</>>
.LP
This does not
'\" <</ital-is-var>>
.I draw
'\" <<ital-is-var>>
the image on the map; it merely defines it so the client knows what to draw when an image of
the given
.B Name
at the specified
.B Zoom
factor is called for.
.LP
Note on clients retrieving images by server ID when
.B IsLocalFile
is
.B false
and
.B File
contains a server-side ID:
as currently implemented, the 
.B mapper
client checks to see if it has a cached version of the file. If so, and that
file is newer than 2 days, it is used without further checks. If the cached file
is older, the server is queried to see if it has a newer version of the file; if so,
that is retrieved and cached; otherwise, the existing cache is updated to note that
it was the known latest version as of that moment. If no usable cache file is available,
the file with the given
id
is obtained from the server. For example, if the image
id
were
.RB \*(lq abcdefg \*(rq,
the URL of the file to be retrieved would be
.IB base /a/ab/abcdefg.gif
or
.IB base /a/ab/abcdefg.png
where
.I base
is the base URL as specified to the 
.BI \-\-curl\-url\-base= base
option (or 
.BI curl\-url\-base= base
configuration file line).
.LP
Servers SHOULD be set up to provide alternative file formats so that, for example,
with ID
.B abcdefg
files such as 
.B a/ab/abcdefg.jpg
(JPEG format)
or
.B a/ab/abcdefg.png
(PNG format)
may be retrieved for clients which use those other formats. 
Currently,
.B mapper.tcl
uses GIF or PNG format files.
.RE
.TP
.B AI?
Request for the named image.
Clients may send this if they need an image of the given
.I name
and 
.I zoom
(as described above for the
.B AI
command) but no such image is defined yet in the client. This
queries the server or connected peers to see if any of them know
of the needed image. The client should continue to process tasks without
waiting for a response (which is never guaranteed). If another peer knows
of the requested image, it should respond with an
.RB \*(lq AI \*(rq
command.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.BI Name
The image name as known to the mapper.
.TP
'\" <</ital-is-var>>
.BI Sizes " (list of objects)"
'\" <<ital-is-var>>
The list of sizes for which the image data are requested.
Each element of the list is an object with the following field:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Zoom " (float)"
'\" <<ital-is-var>>
The requested magnification factor for the image.
.RE
.\" <</>>
.RE
.\" <</>>
.TP
.B AI/
Filters (removes) all the saved image definitions held in the server's database
whose names match a regular expression.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.B Filter
The regular expression used to select which image names will be removed.
.TP
'\" <</ital-is-var>>
.BI "KeepMatching " (bool)
'\" <<ital-is-var>>
If true, only those images whose names match the
.B Filter
expression will be kept; the others will be removed. Otherwise,
the opposite is done: images whose names match
.B Filter
will be removed.
.RE
'\" <</>>
.TP
.B ALLOW
The client MAY send this command to the server after logging in. This tells
the server that the client supports one or more optional features. The
JSON payload has the following field:
.RS
'\" <<list>>
.TP
'\" <</ital-is-var>>
.BI Features " (list of strings)"
'\" <<ital-is-var>>
This is a list of feature names which the client wishes to enable.
Every time an
.B ALLOW
command is given, it resets the entire set of features, rather than 
adding to them.
Currently, the following one features are recognized:
.RS
'\" <<list>>
.TP
.B DICE-COLOR-BOXES
The client supports formatting controls in the die-roll title string sent
to the server in the
.B D
command and received from the server via the
.B ROLL
command. Specifically, the title may consist of multiple sub-titles
separated by U+2016 characters 
'\" <<TeX>>
'\"($\|$).
(||). 
'\" <</TeX>>
Each of these may also have a suffix
consisting of the U+2261 (\[==]) character followed by a color name or
.BI # rrggbb
color code, indicating the foreground color for that part of the title. A second
such suffix may be added to indicate the background color. If this feature is
not enabled, these formatting codes are stripped out by the server before sending
die roll results to a client which isn't prepared to interpret them.
.TP
.B DICE-COLOR-LABELS
The client supports formatting controls in die-roll label fields in the roll details
in a format as described above for sub-titles. This allows custom colors to be used
for special die-roll modifiers that need to stand out visually from all the rest.
'\" <<New>>
.TP
.B GMA-MARKUP
The client is capable of interpreting GMA markup formatting codes received in chat messages.
'\" <</New>>
'\" <</>>
'\" <</>>
.RE
.RE
.TP
.B AUTH
If the server included a challenge string (see the
.B OK
command below), then it requires a password before the client is allowed to
join the server. This is intended to prevent accidental connections by clients
to the wrong servers, and to filter out nuisance connections from spammers or
other random connections, so it is a fairly simple authentication mechanism
using a password shared by all clients in a play group.
The payload is a JSON object with the following parameters:
'\" <<list>>
.RS
.TP
.B Client
This describes the client program. By convention, this value
SHOULD include the version number (e.g., \*(lqmapper 4.0.1\*(rq).
.TP
'\" <</ital-is-var>>
.BI Response " (base64-encoded bytes)"
'\" <<ital-is-var>>
The client's response to the server's challenge.
.TP
.B User
If provided, the
.B User
field gives the local username of the player who is
running the client. This name will be displayed for purposes
such as chat-window conversations and dice rolling. If not
provided, \*(lqanonymous\*(rq will be used, unless the authentication
is successful for the GM role, in which case \*(lqGM\*(rq will be
used regardless of any value sent by the client for the
.B User
field.
'\" <</>>
.LP
Calculation of the 
.B Response
field is as follows.
.LP
Given:
'\" <<TeX>>
'\" \begin{align*}
'\"  C & \text{ is the server's challenge as a binary string of bytes }\\
'\"    & \text{ (after decoding from the base-64 string sent by the server),} \\
'\"  i & \text{ is the number of hash rounds to apply,} \\
'\"  H(x) & \text{ is the binary SHA-256 hash digest of \(x\),} \\
'\"  P & \text{ is the password needed to connect to the server, and the notation} \\
'\"  x || y& \text{ means to concatenate the strings \(x\) and \(y\),}
'\" \end{align*}
'\" then the procedure to calculate the \z{Response} string is:
'\" \begin{enumerate}
'\"  \item If $i=0$ or was not provided by the server, obtain $i$ by extracting the first two bytes from $C$ as an unsigned, big-endian,
'\" 16-bit integer value.
'\"  \item Calculate $D=H(C||P)$.
'\"  \item Repeat $i$ times:
'\"  \begin{enumerate}
'\"   \item Calculate $D'=H(P||D)$.
'\"   \item Let $D=D'$.
'\"  \end{enumerate}
'\" \end{enumerate}
.\" <<desc>>
.TP 5
.I C
is the server's challenge as a binary string of bytes (after decoding from the base-64 string actually sent by the server),
.TP
.I i
is the number of rounds of hash function to apply,
.TP
.RI H( x )
is the binary SHA-256 hash digest of 
.IR x ,
.TP
.I P
is the password needed to connect to the server, and the notation
.TP
.IR x || y
means to concatenate strings
.I x
and 
.IR y ,
.\" <</>>
.LP
To calculate the
.B Response
string, the client must do the following:
.\" <<enum>>
.TP 4
(1)
If no value for
.I i
was provided by the server, obtain
.I i
by extracting the first two bytes from
.I C
as an unsigned, big-endian, 16-bit integer value.
.TP
(2)
Calculate 
.IR D =H( C || P ).
.TP
(3)
Repeat 
.I i
times: Calculate 
.IR D '=H( P || D "); then let " D = D '
.\" <</>>
'\" <</TeX>>
.LP
The binary value of 
'\" <</ital-is-var>>
.I D
'\" <<ital-is-var>>
is then encoded using base-64 and sent as the
.B Response
value.
.LP
Starting with protocol version 332, the server is guaranteed to
respond to the
.B AUTH
command with either a 
.B DENIED
or
.B GRANTED
message (q.v.). The client MAY wait for this response before proceeding
with its other operations, so that it knows for sure how the authentication
went.
.RE
.TP
.B AV
Adjust the map's viewport by making the grid square identified by the
.B Grid
parameter visible at the top-left of the display. If this field is not
present or is empty, then clients MAY fall back to the older behavior of
adjusting the
view by setting the horizontal scrollbar to 
.B XView
as a fraction of its full distance, where 0.0 is all the way to the left and
1.0 is all the way to the right; the vertical scrollbar is similarly set based on
.B YView
where 0.0 is all the way to the top and 1.0 is all the way to the bottom.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.B Grid
The name of the grid square which should be in the upper-left of the display.
This uses the same naming convention as the grid is labelled on the display
(e.g., the far upper-left grid square of the entire map is
.BR A0 ).
.TP
'\" <</ital-is-var>>
.BI XView " (float)"
The fraction of full distance the
.IR x -axis
scrollbar should be moved to.
.TP
.BI YView " (float)"
As
.BR XView ,
but for the 
.I y
axis.
'\" <<ital-is-var>>
.RE
'\" <</>>
.TP
.B CC
Clear the chat history. The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.BI RequestedBy
The name of the user who initiated this operation, if known. 
Clients SHOULD NOT set this field; it is set by the server when sending this
message to clients.
.TP
'\" <</ital-is-var>>
.BI DoSilently " (bool)"
If true, the client MAY clear its chat history without notifying the user;
otherwise it SHOULD indicate the action to the user.
.TP
.BI Target " (int)"
If 0 or missing, clear all messages in the history. Otherwise, if positive, clear all
messages with 
.B MessageID
less than the
.B target
value. If negative, clear all but the most recent
'\" <<ital-is-var>>
.RI \- target
messages (e.g., a
.I target
of \-50 clears all but the most recent 50 messages).
.TP
'\" <</ital-is-var>>
.BI MessageID " (int)"
'\" <<ital-is-var>>
This message counts the same as a chat message and is included in the history
itself. Thus, the server sets this field to a unique identifier for this
message. Clients SHOULD NOT set this field.
.RE
'\" <</>>
.TP
.B CLR
Remove object with a given internal ID from the map. The payload is a JSON
object with the following field:
'\" <<list>>
.RS
.TP
.BI ObjID
This may be the object ID for the specific object to remove, or
.RB \*(lq * \(rq 
to mean all objects should be removed;
.RB \*(lq E* \(rq 
to mean all map elements should be removed;
.RB \*(lq M* \(rq 
to mean all monster tokens should be removed;
.RB \*(lq P* \(rq 
to mean all player tokens should be removed;
or the form
.RI \*(lq[ imagename =] name \*(rq)
may be used, which removes a creature token whose display name matches the
.B name
value.
.RE
'\" <</>>
.TP
.B CLR@
This command tells the client to \*(lqunload\*(rq the contents of a map
file. In other words, all the elements listed in that file are removed from
the map canvas rather than being added to it. The payload is a JSON object
with the following fields:
'\" <<list>>
.RS
.TP
.B File
The pathname or server ID which specifies the map file in question.
.TP
'\" <</ital-is-var>>
.BI IsLocalFile " (bool)"
'\" <<ital-is-var>>
If true, 
.B File
refers to a local file the client can read directly. Otherwise it is
a server ID which can be used to fetch the file from its cache or from
the server.
.RE
'\" <</>>
.TP
.B CO
Sets the combat mode state in the client.  The payload is a JSON object
with the following attribute:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Enabled " (bool)"
'\" <<ital-is-var>>
If true, the client should be in combat (initiative) mode, otherwise it should not.
.RE
'\" <</>>
.TP
.B CONN
Update the list of connected peer clients to those described in the JSON
payload, which contains the following field.
Clients MUST NOT send this command. This supersedes the
.BR CONN ,
.BR CONN: ,
and 
.BR CONN.
commands from protocol versions prior to 400.
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI PeerList " (list of objects)"
'\" <<ital-is-var>>
A list of objects, each describing a single connected client, with the following
fields:
'\" <<list>>
.RS
.TP
.BI Addr
The IP address and port the peer connected from.
.TP
.BI User
The username as provided during authentication.
.TP
.BI Client
The name of the client program in use.
.TP
'\" <</ital-is-var>>
.BI LastPolo " (float)"
The number of seconds since the server last heard a 
.B POLO
command from the peer.
.TP
.BI IsAuthenticated " (bool)"
If true, the client successfully negotiated the server's authentication process.
.TP
.BI IsMe " (bool)"
'\" <<ital-is-var>>
If true, this object describes the client which received this command.
'\" <</>>
.RE
'\" <</>>
.RE
.TP
.B CORE
Query the server's core SRD database. The server SHOULD respond with a
.B CORE=
message containing the requested item or indicating that no such item was found.
The payload is a JSON object with the following attributes:
'\" <<list>>
.RS
.TP
.B Type
The type of object being requested. Currently the supported types include
.BR bestiary ,
.BR class ,
.BR feat ,
.BR language ,
.BR skill ,
.BR spell ,
and
.BR weapon .
.TP
.B Code
The GMA unique code that identifies the entry.
May be blank since only one of
.B Code
and 
.B Name
is necessary.
.TP
.B Name
The common name of the entry. 
May be blank since only one of
.B Code
and 
.B Name
is necessary.
.TP
.B RequestID
If you place an arbitrary string value in this field, it will be sent back to you
in the corresponding
.B CORE=
response message.
.RE
'\" <</>>
.TP
.B CORE=
This message from the server provides core SRD data for an item that the client might want to
know about. Typically, this is in response to a
.B CORE
message from the client requesting this information. Clients MUST gracefully deal with the
receipt of a
.B CORE=
message they didn't need or are no longer interested in, as well as the case where they requested
core data but received no corresponding response.
The payload is a JSON object containing the requested data, with the following attributes:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI "NoSuchEntry " (bool)
If true, the requested entry was not found in the database. Otherwise (including the case where this attribute is
missing) the remaining attributes contain the requested information.
.TP
.BI "IsHidden " (bool)
If true, the requested entry is hidden from player view by the GM. No
.B Data
field will be given.
.TP
.BI "IsLocal " (bool)
If present and true, this entry was a local addition to the database. Otherwise it was imported from publicly-available
SRD data for the game system.
.TP
.B Code
The GMA code for the requested item.
.TP
.B Name
The GMA name for the requested item.
.TP
.B Type
The type of core data item being provided, as per the
.B Type
field of the
.B CORE
message (q.v.).
.TP
.B RequestID
If present and non-empty, this is the
.B RequestID
value provided by the client when making the request that resulted in this reply.
.TP
.B Data
This value is a JSON-encoded object containing the specific data relating to the item in question. Its format depends on
the item
.BR Type .
.LP
The
.B Data
payload for each type is described in the following sections.
'\" <</bold-is-fixed>>
.B "N.B. The descriptions that follow of the various Data objects are speculative at this point and entirely subject to change."
'\" <<bold-is-fixed>>
.TP
.BR "Data " "fields for" " bestiary " "type items:"
'\" <<list>>
.RS
.TP
.B ImageTag
If the GM maintains a library of creature token images for their local bestiary,
and one is defined for this creature, then this field will contain the image tag
name for this creature's token.
.TP
.B Species
The name of the species of the creature.
.TP
.B CR
The challenge rating of the creature. Fractions may appear as, e.g.,
.BR 1/2 .
.TP
.BI "XP " (int)
XP reward for defeating the creature.
.TP
.B Class
The class and levels if applicable.
.TP
.BI "Alignment " (object)
The alignment for the creature, as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "Alignments " (list)
A list of alignment codes
.RB ( CG ,
.BR LN ,
etc.)
which this creature may be.
.TP
.B Special
Any special comment about alignment.
.RE
'\" <</>>
.TP
.B Source
The reference to the source this item originally came from.
.TP
.BI "Size " (object)
The creature's size, as an object with the following fields:
'\" <<list>>
.RS
.TP
.B Code
The size code as documented in the GMA encounter and familiar data.
.TP
.B SpaceText
Any comment about the creature's threatened space.
.TP
.B ReachText
Any comment about the creature's reach distance.
.RE
'\" <</>>
.TP
.B Type
Creature type.
.TP
.BI "Subtypes " (list)
List of applicable subtypes.
.TP
.BI "Initiative " (object)
The creature's initiative modifier, as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "Mod " (int)
The total initiative modifier value.
.TP
.B Special
Any special information related to initiative.
.RE
'\" <</>>
.TP
.B Senses
A description of the creature's senses.
.TP
.B Aura
A description of the creature's aura effect.
.TP
.BI "HP " (object)
The creature's hit points as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "Typical " (int)
Typical hit point total.
.TP
.BI "Current " (int)
The creature's current hit point total.
.TP
.B Special
Any special comments about the creature's health.
.TP
.B HitDice
The hit dice die-roll specification.
.RE
'\" <</>>
.TP
.BI "Save " (object)
The creature's saving throws, as an object with these fields:
'\" <<list>>
.RS
.TP
.BI "Fort " (object)
The Fortitude saving throw, as an object with these fields:
'\" <<list>>
.RS
.TP
.BI "Mod " (int)
The total saving throw modifier value.
.TP
.BI Special
Any special commentary about this saving throw.
.TP
.BI "NoSavingThrow " (bool)
If true, the creature has no such saving throw at all and the other fields should be ignored.
.RE
'\" <</>>
.TP
.BI "Refl " (object)
The creature's Reflex saving throw, in the same format as the Fortitude saving throw.
.TP
.BI "Will " (object)
The creature's Will saving throw, in the same format as the Fortitude saving throw.
.TP
.B Special
Any special comments about the creature's saving throws.
'\" <</>>
.RE
.TP
.B DefensiveAbilities
A description of the creature's defensive abilities.
.TP
.BI "DR " (object)
The creature's damage reduction, as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "DR " (int)
The number of hit points resisted.
.TP
.B Bypass
Description of what will bypass the DR.
'\" <</>>
.RE
.TP
.B Immunities
A description of the things the creature is immune from.
.TP
.B Resists
A description of the resistances the creature has.
.TP
.BI "Speed " (object)
The creature's movement speed, as an object with the following fields:
'\" <<list>>
.RS
.TP
.B Code
The encoded list of speeds.
.TP
.B Special
Additional commentary about movement speed.
'\" <</>>
.RE
.TP
.B SpecialAttacks
A description of the various special attacks the creature may make.

.TP
.B Resists
A description of the resistances the creature has.
.TP
.BI "Speed " (object)
The creature's movement speed, as an object with the following fields:
'\" <<list>>
.RS
.TP
.B Code
The encoded list of speeds.
.TP
.B Special
Additional commentary about movement speed.
'\" <</>>
.RE
.TP
.B SpecialAttacks
A description of the various special attacks the creature may make.
.TP
.BI "Abilities " (object)
The creature's ability scores, as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "Str " (object)
The Strength score, as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "Base " (int)
The raw ability score value.
.TP
.B Special
Any special notes about this ability score.
.TP
.BI "NullScore " (bool)
If true, the creature does not have this ability score at all, and the other fields should be ignored.
'\" <</>>
.RE
.TP
.BI "Dex " (object)
The Dexterity score, as an object in the same format as Strength.
.TP
.BI "Con " (object)
The Constitution score, as an object in the same format as Strength.
.TP
.BI "Int " (object)
The Intelligence score, as an object in the same format as Strength.
.TP
.BI "Wis " (object)
The Wisdom score, as an object in the same format as Strength.
.TP
.BI "Cha " (object)
The Charisma score, as an object in the same format as Strength.
'\" <</>>
.RE
.TP
.BI "Combat " (object)
The combat statistics for the creature, as an object with the following fields:
'\" <<list>>
.RS
.TP
.BI "BAB " (int)
The base attack bonus.
.TP
.BI "CMB " (int)
The combat maneuver bonus.
.TP
.BI "CMD " (int)
The combat maneuver defense value.
.TP
.B CMBSpecial
Any special notes on the CMB.
.TP
.B CMDSpecial
Any special notes on the CMD.
'\" <</>>
.RE
.TP
.B SQ
A description of the creature's special qualities.
.TP
.B Environment
A description of the environment where this creature commonly appears.
.TP
.B Organization
A description of the groups in which this creature is usually found.
.TP
.B Treasure
The treasure type and amount usually found with this creature.
.TP
.B Appearance
A short description of the creature's physical appearance.
.TP
.BI "IsTemplate " (bool)
If true, this is a template from which other creatures can be built.
.TP
.BI "Strategy " (object)
The creature's strategy in an encounter, as an object with these fields:
'\" <<list>>
.RS
.TP
.B BeforeCombat
How the creature will prepare for the encounter.
.TP
.B DuringCombat
How the creature will manage its encounter with the players.
.TP
.B Morale
How resolute the creature is in the face of deadly combat.
'\" <</>>
.RE
.TP
.BI "IsCharacter " (bool)
If true, this is a creature that may be a character.
.TP
.BI "IsCompanion " (bool)
If true, this creature may be a companion.
.TP
.BI "IsUnique " (bool)
If true, there is only one of this creature in existence.
.TP
.B AgeCagetory
The age category for the creature.
.TP
.B Gender
The creature's gender
.TP
.B Bloodline
The creature's bloodline.
.TP
.B Patron
The creature's patron deity.
.TP
.B AlternateNameForm
.TP
.BI "DontUseRacialHD " (bool)
If true, don't use racial hit dice when creating a character with levels.
.TP
.B VariantParent
.TP
.BI "Mythic " (object)
'\" <<list>>
.RS
.TP
.BI "IsMythic " (bool)
.TP
.BI "MR " (int)
.TP
.BI "MT " (int)
'\" <</>>
.RE
.TP
.B OffenseNote
.TP
.B StatisticsNote
.TP
.BI "Gear " (object)
'\" <<list>>
.RS
.TP
.B Combat
.TP
.B Other
'\" <</>>
.RE
.TP
.BI "Schools " (object)
'\" <<list>>
.RS
.TP
.B Focused
.TP
.B Prohibited
.TP
.B Opposition
'\" <</>>
.RE
.TP
.B ClassArchetypes
.TP
.B BaseStatistics
.TP
.B RacialMods
.TP
.B Mystery
.TP
.B Notes
.TP
.BI "Domains " (list)
.TP
.BI "AC " (object)
'\" <<list>>
.RS
.TP
.BI "Components " (object)
.TP
.BI "Adjustments " (object)
'\" <</>>
.RE
.TP
.BI "AttackModes " "(list of objects)"
'\" <<list>>
.RS
.TP
.BI "Tier " (int)
.TP
.B BaseWeaponID
.TP
.BI "Multiple " (int)
.TP
.B Name
.TP
.B Attack
.TP
.B Damage
.TP
.BI "Critical " (object)
'\" <<list>>
.RS
.TP
.BI "CantCritical " (bool)
.TP
.BI "Threat " (int)
.TP
.BI "Multiplier " (int)
'\" <</>>
.RE
.TP
.BI "Ranged " (object)
'\" <<list>>
.RS
.TP
.BI "IsRanged " (bool)
.TP
.BI "Increment " (int)
.TP
.BI "MaxIncrements " (int)
'\" <</>>
.RE
.TP
.BI "IsReach " (bool)
.TP
.B Special
.TP
.B Mode
'\" <</>>
.RE
.TP
.BI "Languages " "(list of objects)"
'\" <<list>>
.RS
.TP
.B Name
.TP
.BI "IsMute " (bool)
.TP
.B Special
'\" <</>>
.RE
.TP
.BI "Feats " "(list of objects)"
'\" <<list>>
.RS
.TP
.B Code
.TP
.B Parameters
.TP
.BI "IsBonus " (bool)
'\" <</>>
.RE
.TP
.BI "Skills " "(list of objects)"
'\" <<list>>
.RS
.TP
.B Code
.TP
.BI "Modifier " (int)
.TP
.B Notes
'\" <</>>
.RE
.TP
.BI "Spells " "(list of objects)"
'\" <<list>>
.RS
.TP
.B ClassName
.TP
.BI "CL " (int)
.TP
.BI "Concentration " (int)
.TP
.BI "NoConcentration " (bool)
.TP
.BI "PlusDomain " (int)
.TP
.B Description
.TP
.B Special
.TP
.BI "Spells " "(list of objects)"
'\" <<list>>
.RS
.TP
.B Name
.TP
.B AlternateName
.TP
.B Frequency
.TP
.B Special
.TP
.BI "Slots " "(list of objects)"
'\" <<list>>
.RS
.TP
.BI "IsCast " (bool)
.TP
.BI "IsDomain " (bool)
.TP
.BI "MetaMagic " (list)
'\" <</>>
.RE
'\" <</>>
.RE
'\" <</>>
.RE
.RE
'\" <</>>
.TP
.BR "Data " "fields for" " class " "type items:"
'\" <<list>>
.RS
.TP
.BI "Spells " (object)
Describes the spell-casting capability of the class, with the following fields:
'\" <<list>>
.RS
.TP
.B Type
The magic type (arcane, etc.)
.TP
.B Ability
The name of the ability score relevant to spells.
.TP
.BI "HasBonusSpells " (bool)
True if the class allows bonus spells (e.g., clerics' domain spells)
.TP
.BI "IsSpontaneousCaster " (bool)
True if the class casts spells without needing to prepare them in advance.
.TP
.BI "CastPerDay " (list)
A list of the number of spells which may be cast per day. Each element is an object which has the following values:
'\" <<list>>
.RS
.TP
.BI "ClassLevel " (int)
The class level for which this applies.
.TP
.BI "SpellLevel " (int)
The level of spell for which this applies.
.TP
.BI "IsProhibited " (bool)
If true, this level of spell is not possible at this class level.
.TP
.BI "IsUnlimitedUse " (bool)
If true, this level of spell can be used an unlimited number of times per day at this class level.
.TP
.BI "Number " (int)
The number of spells granted at this spell and class level.
.RE
'\" <</>>
.TP
.BI "PreparedPerDay " (object)
The number of spells which may be prepared per day by class level and spell level. Each element has the same
values as for the 
.B CastPerDay
attribute above.
.TP
.BI "SpellsKnown " (object)
The number of spells which may be known by class level and spell level. Each element has the same
values as for the 
.B CastPerDay
attribute above.
.RE
'\" <</>>
.RE
'\" <</>>
.TP
.BR "Data " "fields for" " feat " "type items:"
'\" <<list>>
.RS
.TP
.B Parameters
Describes the parameters allowed for the feat, if any.
.TP
.B Description
The text description of the feat.
.TP
.B Prerequisites
The text description of the prerequisites for the feat.
.TP
.B Benefit
Description of the benefit granted by taking this feat.
.TP
.B Normal
Description of the situation if the feat is not taken.
.TP
.B Special
Any special notes or circumstances.
.TP
.B Source
The reference to the source book or other place where this feat origially came from.
.TP
.B Race
.TP
.B Note
.TP
.B Goal
.TP
.B CompletionBenefit
.TP
.B SuggestedTraits
.TP
.BI "Types " (list)
A list of feat types to which this belongs.
.TP
.BI "FlagNames " (list)
A list of flags which apply to this feat.
.TP
.BI "MetaMagic " (object)
If this is a metamagic feat, the following fields will appear in the
.B MetaMagic
attribute:
'\" <<list>>
.RS
.TP
.BI "IsMetaMagicFeat " (bool)
If true, this is a metamagic feat and the other fields here will apply.
.TP
.B Adjective
.TP
.BI "LevelCost " (int)
The number of levels this feat costs (i.e., the number of spell slots higher than normal this spell will use).
.TP
.BI "IsLevelCostVariable " (bool)
If true, the spell level cost is not fixed.
.TP
.B Symbol
The symbol to use on GMA character record sheets and encounter run sheets for spells which were prepared with this feat.
.RE
'\" <</>>
.RE
.TP
.BR "Data " "fields for" " language " "type items:"
.RS
There is no additional data. The language name appears in the
.B Name
field.
.RE
.TP
.BR "Data " "fields for" " skill " "type items:"
'\" <<list>>
.RS
.TP
.BI "ClassSkillFor " (list)
A list of the class codes for which clases this skill is a class skill.
.TP
.B Ability
Relevant ability score name.
.TP
.BI "HasArmorPenalty " (bool)
If true, this skill is subject to an armor check penalty.
.TP
.BI "TrainingRequired " (bool)
If true, the character must be trained to use this skill.
.TP
.B Source
The reference to the original source for this skill.
.TP
.B Description
The abbreviated text description of the skill.
.TP
.B FullText
The full text description of the skill.
.TP
.B ParentSkill
The name of the parent skill if applicable.
.TP
.BI "IsVirtual " (bool)
If true, this skill cannot be taken; one of its children must be taken specifically.
.TP
.BI "IsBackground " (bool)
If true, this is a background skill.
.RE
'\" <</>>
.TP
.BR "Data " "fields for" " spell " "type items:"
'\" <<list>>
.RS
.TP
.B School
.TP
.BI "Descriptors " (list)
.TP
.BI "Components " (object)
'\" <<list>>
.RS
.TP
.BI "Components " (list)
.TP
.B Material
.TP
.B Focus
.TP
.BI "HasCostlyComponents " (bool)
.TP
.BI "MaterialCosts " (int)
'\" <</>>
.RE
.TP
.BI "Casting " (object)
'\" <<list>>
.RS
.TP
.B Time
.TP
.B Special
'\" <</>>
.RE
.TP
.BI "Range " (object)
'\" <<list>>
.RS
.TP
.B Range
.TP
.BI "Distance " (int)
.TP
.BI "DistancePerLevel " (int)
.TP
.B DistanceSpecial
'\" <</>>
.RE
.TP
.BI "Effect " (object)
'\" <<list>>
.RS
.TP
.B Area
.TP
.B Effect
.TP
.B Targets
'\" <</>>
.RE
.TP
.BI "Duration " (object)
'\" <<list>>
.RS
.TP
.B Duration
.TP
.B Special
.TP
.BI "Concentration " (bool)
.TP
.BI "PerLevel " (bool)
'\" <</>>
.RE
.TP
.BI "SR " (object)
'\" <<list>>
.RS
.TP
.B SR
.TP
.B Special
.TP
.BI "Object " (bool)
.TP
.BI "Harmless " (bool)
'\" <</>>
.RE
.TP
.BI "Save " (object)
'\" <<list>>
.RS
.TP
.B SavingThrow
.TP
.B Effect
.TP
.B Special
.TP
.BI "Object " (bool)
.TP
.BI "Harmless " (bool)
'\" <</>>
.RE
.TP
.BI "IsDismissible " (bool)
.TP
.BI "IsDischarge " (bool)
.TP
.BI "IsShapeable " (bool)
.TP
.BI "ClassLevels " "(list of objects)"
'\" <<list>>
.RS
.TP
.B Class
.TP
.BI "Level " (int)
'\" <</>>
.RE
.TP
.B Deity
.TP
.B Domain
.TP
.B Description
.TP
.B Source
.TP
.B Bloodline
.TP
.B Patron
.RE
'\" <</>>
.TP
.BR "Data " "fields for" " weapon " "type items:"
'\" <<list>>
.RS
.TP
.BI "Cost " (int)
The cost in copper pieces for a standard weapon of this type.
.TP
.BI "Damage " (object)
The damage done by this weapon. The value is an object where the keys are size category codes and the values are the damage
done by a weapon of that size category.
.TP
.BI "Critical " (object)
The critical hit stats for the weapon. This is an object with the following fields.
'\" <<list>>
.RS
.TP 
.BI "CantCritical " (bool)
If true, this weapon cannot score a critical hit at all. The other fields should be ignored.
.TP
.BI "Multiplier " (int)
The number of extra dice to add when a critical hit is scored.
.TP
.BI "Threat " (int)
The minimum die value to threaten a critical hit (e.g., 19 means to threaten on a natural 19\-20).
.TP
.RS
'\" <</>>
.TP
.BI "Ranged " (object)
For ranged weapons, the fields in this attribute describe those parameters.
'\" <<list>>
.RS
.TP
.BI "Increment " (int)
The range increment for the weapon.
.TP
.BI "MaxIncrements " (int)
The maximum number of increments before the target is out of range.
.TP
.BI "IsRanged " (bool)
If true, this is a ranged weapon and the other fields are meaningful.
.RE
'\" <</>>
.RE
.TP
.BI "Weight " (int)
The weight in grams of the weapon.
.TP
.BI "DamageType " (list)
The type of damage done. This is a list of strings, with each indicating a damage type such as 
.B B
for bludgeoning,
.B P
for piercing,
and
.B S
for slashing.
.TP
.BI "Qualities " (list)
A list of weapon qualities. The codes in the list may include:
.B 1
(one-handed),
.B 2
(two-handed),
.B b
(brace),
.B D
(disarm),
.B d
(double),
.B E
(Elven),
.B f
(fragile),
.B G
(Gnome),
.B g
(grapple),
.B H
(Halfling),
.B L
(light),
.B M
(monk),
.B m
(martial),
.B O
(Orc),
.B R
(ranged),
.B r
(reach),
.B S
(non-lethal),
.B s
(simple),
.B t
(trip),
.B U
(unarmed),
.B W
(Dwarven),
.B X
(exotic),
.B x
(deadly),
and
.B Z
(masterwork).
.RE
'\" <</>>
'\" <</>>
'\" <</>>
.RE
.RE
'\" <<ital-is-var>>
.TP
.B CORE/
Filter the core database items which are visible to the players.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.B Filter
This is a regular expression matching the
.B Code
value of all the entries to be affected by this command.
.TP
.B Type
The type of core data entry to target.
.TP
'\" <</ital-is-var>>
.BI "IsHidden " (bool)
If true, set the entries matching the
.B Filter
expression so they are hidden from the players. Otherwise, make them visible.
.TP
.BI "InvertSelection " (bool)
If true, all entries which do
.I not
match
.B Filter
are affected.
'\" <<ital-is-var>>
.RE
'\" <</>>
.TP
.B COREIDX
Query the core database to retrieve a list of entries. This gives the information by which the
actual data behind these entries may be retrieved using the
.B CORE
message. The payload includes the following fields:
'\" <<list>>
.RS
.TP
.B Type
The type of entry to index, as per the
.B CORE
message.
.TP
.B CodeRegex
If present and non-empty, limit the responses to those whose
.B Code
field matches this regular expression.
.TP
.B NameRegex
If present and non-empty, limit the responses to those whose
.B Name
field matches this regular expression.
.TP
'\" <</ital-is-var>>
.BI "Since " "(RFC 3339-formatted datetime string)"
'\" <<ital-is-var>>
If present and non-empty, limit the responses to those which were modified
since the given date and time.
.TP
.B RequestID
If a string value is provided here, it will be repeated in the server's
response message.
'\" <</>>
.RE
.TP
.B COREIDX=
The server response to a
.B COREIDX
message. Since the number of entries in the database may be quite large, the server will
send a number of these reply messages, one per item from the database.
It includes the following fields:
'\" <<list>>
.RS
.TP
.B RequestID
The
.B RequestID
sent to the server in the 
.B COREIDX
request that initiated this update, if any.
.TP
.B Type
The database item type
.TP
'\" <</ital-is-var>>
.BI "IsDone " (bool)
If true, this is the final response in this set.
.TP
.BI "N " (int)
The number of response this is, starting with 1.
.TP
.BI "Of " (int)
The total number of responses that will be given.
'\" <<ital-is-var>>
.TP
.B Name
The item's name.
.TP
.B Code
The item's code.
'\" <</>>
.RE
.TP
.B CS
Update the client's clock.
The JSON payload includes the following fields:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Absolute " (int64)"
The absolute time on the GMA world clock (in tenths of seconds since the epoch).
.TP
.BI Relative " (int64)"
The elapsed time on the GMA world clock (in tenths of seconds since the GM set a
reference point, e.g., the start of combat).
.TP
.BI Running " (bool)"
'\" <<ital-is-var>>
If true, the local client should continue advancing the clock in real-time locally after updating the time to the new absolute time.
Otherwise, cancel real-time updates if they were running, leaving the clock at the given absolute time. The local real-time updating
events should only be performed when not in combat mode.
'\" <</>>
.RE
.TP
.B D
Roll dice using the server's built-in die rolling facility.
The JSON payload contains the following fields:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Recipients " (list of strings)"
The names of the people who should receive the results
of the die roll. For global or GM results, this should be 
.BR null .
.TP
.B RequestID
If you put a string value in this field, it will be sent back in any
.B ROLL
response messages the server sends to you in response to this request. This
allows a client to associate responses to the requests that generated them.
You may leave this blank or omit it if you don't care to match requests with
responses.
.TP
.BI ToAll " (bool)"
If true, this is a global die-roll, and the result should be
sent to all clients.
.TP
.BI ToGM " (bool)"
If true, this die-roll will be sent \*(lqblind\*(rq to the GM only.
Not even the requester will see the result of the roll, only the GM will.
.TP
.BI RollSpec
'\" <<ital-is-var>>
The die-roll specification, like \*(lqd20+12\*(rq or \*(lq6d6 fire\*(rq.
If this field is empty, the previous die-roll from this client is repeated,
or \*(lq1d20\*(rq if there was no previous one.
'\" <</>>
.RE
.TP
.B DD
Define (store) Die-Roll Presets.
Clients send this command to the server to request it to store a set of
die-roll presets for it to retrieve for use in subsequent sessions.
The JSON payload is identical to the one sent by the server in the
.B DD=
command, 
except that it does not contain
.B DelegateFor
or
.B Delegates
fields.
.RS
.LP
The server SHOULD respond by issuing a
.B DD=
command to all peer clients logged in with the same username as the
affected user
as well as any authorized delegates. 
.RE
.TP
.B DD+
Add to Die-Roll Presets.
Clients send this command to the server to add an additional set of die-roll
presets to the collection it was already holding for that user. The JSON
payload is identical to the one sent for the 
.B DD
command.
The server SHOULD respond by issuing a
.B DD=
command to all peer clients logged in with the same username as the
requesting client 
and all authorized delegates.
.TP
.B DD/
Filter die-roll presets. This removes a set of die-roll presets
from the server's storage for the user.
The server SHOULD respond by issuing a
.B DD=
command to all peer clients logged in with the same username as the
affected user
and all authorized delegates.
The JSON payload includes the following fields:
'\" <<list>>
.RS
.TP
.B Filter
The value is a regular expression. The server will delete all die-roll
presets whose
.B Name
attribute matches this regular expression.
'\" <<New>>
'\" <</ital-is-var>>
.TP
.BI Global " (bool)"
If present and true, this operation filters items out of the system-wide global set of presets
instead of a user's set. This makes this a privileged command.
'\" <<ital-is-var>>
'\" <</New>>
.TP
.B For
The name of the user whose presets are being filtered. This is optional;
if omitted, the presets of the user making this request are affected. Only
the GM 
and authorized delegates
may filter other users' presets.
'\" <</>>
.RE
.TP
.B DD=
This command defines the list of die-roll presets the client should know.
This replaces any previous set of presets the client was using.
Clients MUST NOT send this command. This supersedes the commands
.BR DD= ,
.BR DD: ,
and 
.BR DD.\&
in protocol versions prior to 400.
The JSON payload includes the following fields:
'\" <<list>>
.RS
.TP
.B For
The username of the player for whom these presets were stored. The default, if no
name is given or if it is empty, is the currently logged-in user.
.TP
'\" <</ital-is-var>>
'\" <<New>>
.BI Global " (bool)"
If present and true, these presets are the system-wide set that apply to all users rather than those of the target user.
For the
.B DD
command, this means the operation is redefining the entire set of system-wide presets. For
.BR DD+ ,
the operation is adding to the system-wide presets without changing the other existing ones.
.RS
.LP
Note that when any of these commands are sent with this parameter set to true,
they become privileged commands.
.LP
In the 
.B DD=
response from the server, the presence of this parameter with a true value indicates that this 
contains only the system-wide presets. In this case, clients MUST NOT conclude that the absence of the user's personal
presets in the payload means it can delete its copy of the user's presets. Without the
.B Global
parameter, this message contains all presets the client should know about, including the user's set plus the system-wide globals.
.RE
'\" <</New>>
.TP
.BI DelegateFor " (list of strings)"
The list of all the other users for whom the target user is a delegate.
.TP
.BI Delegates " (list of strings)"
The list of delegates who also have visibility and control for the owner's presets.
If empty or missing, there are no delegates.
.TP
.BI Presets " (list of objects)"
Each element in this list describes a single preset. It has the following
fields:
'\" <<list>>
.RS
'\" <<New>>
.TP
.BI Global " (bool)"
If this parameter is present and true, it indicates that this preset was defined at a system-wide level and may
not be changed or deleted by the user. The client MUST track it separately and MUST NOT confuse it with a non-global preset
with the same name. This parameter is only set by the server. Clients MAY NOT set this when defining or modifying presets and sending them
to the server.
.RS
.LP
We RECOMMEND clients use a notation to make system-wide and per-user preset names distinct to the user. For example, the GMA Mapper uses single
prefix characters on names for variables and tables as in
.B $foo
and
.BR #bar ,
but double prefix characters for system-wide names, as in
.B $$foo
and
.BR ##bar .
.RE
'\" <</New>>
'\" <<ital-is-var>>
.TP
.BI Name
The name by which this preset is identified to the user. This MUST
be unique for that user.  The client SHOULD sort the preset list by 
the 
.B Name
field before displaying. If a vertical bar 
.RB (\*(lq | \*(rq) 
appears in the
.BR Name ,
all text up to and including the bar SHOULD be suppressed from display.
.RS
The formatting of the
.B Name
field is not mandated by this specification. However, the following
standard interpretation for data to the left of the vertical bar
(if any) is RECOMMENDED for clients using this feature:
'\" <<enumerate>>
.TP 3
1.
Regular die-roll presets with a preferred display ordering SHOULD
have a three-digit decimal zero-padded sequence number to the left
of the bar, e.g.,
.RB \*(lq 000|attack \*(rq,
.RB \*(lq 001|damage \*(rq,
.RB \*(lq "002|fort save" \*(rq,
etc. The numbers need not be strictly consecutive.
Clients SHOULD use dictionary sorting for preset items so that the numeric sort-order sequence value
is correctly arranged regardless of number of characters; however the recommendation here is also to
pad them with zeroes to three digits for the benefit of clients which cannot or will not do so.
'\" <<New>>
Clients MAY include optional
.I flags
and
.I client_data
fields delimited semicolons following the sequence value (e.g.,
.RB \*(lq 042;b|example \*(rq). 
This contains a number of single-character flags.
The following flag is currently recognized:
.RS
'\" <<list>>
.TP
.B b
Send the die roll blindly to the GM only.
.LP
This means the full definition of the simple preset name is:
.LP
.IR sequence [\fB;\fP flags [\fB;\fP client_data ]]\fB|\fP name
'\" <</>>
.RE
'\" <</New>>
.TP
2.
Stored variables MAY be stored as a die-roll preset with a
.B Name
field in the format
.RS
.LP
.BI \fR\*(lq\fP\[sc] sequence ; var ; flags \fR[\fP; client \fR]\fP| displayname \fR\*(rq.\fP
.LP
where
.B \[sc]
is Unicode character U+00A7 (section symbol),
.I sequence
is a three-digit decimal zero-padded display sequence number as described above,
.I var
is the name of the variable by which the contents of this preset may be inserted into another die-roll specification,
.I flags
are a set of zero or more single-letter flags affecting how the client should use this value, and
.I client
is an optional field with client-specific data not otherwise defined here. If the
.I client
field is not given, the semicolon immediately before it may be omitted as well.
For example:
.LP
.RB \*(lq "\[sc]042;CL;e|caster level" \*(rq
.LP
The
.I flags
are up to the client to interpret, but we RECOMMEND the flag
.RB \*(lq e \*(rq
to mean the value should be enabled (or \*(lqon\*(rq) by default
and
.RB \*(lq g \*(rq
to mean the die-roll expression to the left of it should be grouped together in parentheses.
.LP
If the
.I var
value is empty (e.g., 
.RB \*(lq \[sc]000;;e|inspiration \*(rq),
clients SHOULD interpret this to mean that the preset's value should not be assigned
to a variable name, but should be appended to any die-roll specification made while it
is enabled.
.RE
.TP
3.
It is RECOMMENDED that clients allow for grouping of related presets and/or modifiers
by appending one or more group names to the end of the numeric sort order digits. Each
such name is separated from the digits and each other with a right-pointing triangle
'\" <<TeX>>
'\" ``$\blacktriangleright$'' (Unicode U+25B6).
Unicode U+25B6 (represented here as the 
.RB \*(lq > \*(rq
character).
For example,
'\" \z{012|attack} is an ungrouped attack roll,
.B 012|attack
is an ungrouped attack roll,
'\" \z{013}\allowbreak$\blacktriangleright$\z{monster|attack} is an attack roll belonging to the ``monster'' group,
.B 013>monster|attack
is an attack roll belonging to the \*(lqmonster\*(rq group,
'\" \z{030}$\blacktriangleright$\z{monster}$\blacktriangleright$\z{save|Fortitude} is a Fortitude saving
'\" throw belonging to the ``save'' subgroup of the ``monster'' group, and
.B 030>monster>save|Fortitde
is a Fortitude saving throw belonging to the \*(lqsave\*(rq subgroup of the \*(lqmonster\*(rq group, and
'\" \z{\S042}$\blacktriangleright$\z{monster;;|mod} is a modifier in the ``monster'' group.
.B \[sc]042>monster;;|mod
is a modifier in the \*(lqmonster\*(rq group.
'\" <</TeX>>
Clients SHOULD allow users to collapse all of the die rolls with the same group name(s) appearing consecutively
in the die-roll preset list.
'\" <<New>>
.TP
4.
Stored tables MAY be stored as a die-roll preset with a
.B Name
field in the format
.RS
.LP
.BI # sequence ; flags \fR[\fP; client \fR]\fP| tblname
.LP
and the
.B DieRollSpec
field in the format
.LP
.BI ; dieexpr ; n0 ; t0 ;\fR...\fP; nN-1 ; tN-1 ;*; tN ;
.LP
The field delimeter 
.RB (\*(lq ; \*(rq
in this example) is arbitrary but must be consistent; it is whatever character appears as the first character in
.B DieRollSpec
(to allow for punctuation marks such as semicolons to appear in the table text as needed). The semicolon delimeters
in the
.B Name
field are always semicolons.
This declares a lookup table named
.I tblname
(which MUST be unique within the preset list). The set of
.I flags
is up to the client to manage. Currently the defined flags are:
.RS
'\" <<list>>
.TP
.B b
The die rolls should be send blindly to the GM only.
.TP
.B m
the table's text may include GMA markup formatting codes
.RE
.\" <</>>
.LP
The
.I dieexpr
gives a standard die-roll expression which the client should send to the server whenever a roll on this
table is requested. Following this are a set of cases represented by numeric values
.I n
in increasing order along with corresponding text strings
.I t
which may contain GMA markup formatting codes if the
.B m
flag is present.
The last case, which is taken if the result of the die roll exceeded any of the values of
.I n
found up to that point, is represented by
.RB \*(lq * \*(rq.
.LP
When the user wishes to invoke a random roll using the lookup table, the client will send a die-roll request
to the server with
.I dieexpr
(along with, perhaps, additional modifiers and options) to get a random result back, which is then compared to
the values in the lookup table until a value is found that is greater than or equal to the result, or the final
.RB \*(lq * \*(rq
value is reached, whereupon the corresponding text string is displayed by the client to the user in some
appropriate fashion. Clients SHOULD transmit this result to other clients via a TO message.
.RE
.TP
5.
Clients MAY encode arbitrary dictionaries of complex data into presets by encoding the
.B Name
field as
.RS
.LP
.BI \[co]\fR[\fP sequence \fR[\fP; client_data \fR]]\fP| name
.LP
where
.I sequence
is an optional sequence and/or group hierarchy as described above,
and
.I client_data
is an arbitrary string to be interpreted by other programs consuming this preset data as they choose. \
In this case, the
.B DieRollSpec
field MUST be a properly-formed JSON object string with no newline characters that encodes the data being stored
in this preset. The \*(lq\[co]\*(rq character is the Unicode codepoint U+00A9.
.RE
'\" <</New>>
.TP
6.
Clients 
MUST 
gracefully handle the existence of data formats not listed
above without losing or corrupting any presets or metadata.
.RS
.LP
Notably, the
.BR gma (6)
program itself automates the creation and destruction of ephemeral presets
for combatants on an encounter-by-encounter basis. The names for these presets
include an additional component,
.IR area ,
which identifies the dungeon location or encounter identifier. 
'\" <<New>>
To accomplish this, GMA prepends the string
.BI $[ area ]
to the
.I client_data
field for any of the complex types which support that. Otherwise it prepends that string to
the
.I sequence
value.
'\" <</New>>
.RE
'\" <</>>
.RE
.TP
.BI Description
A text description of the purpose of the preset.
.TP
.BI DieRollSpec
The die-roll specification to send to the server when rolling this preset.
'\" <</>>
.RE
'\" <</>>
.RE
.TP
.B DDD
Define Die-roll Delegate.
Clients send this command to the server to indicate that other user(s)
are allowed to retrieve and store their die-roll presets.
The server SHOULD immediately send 
.B DD=
commands to the requesting user and all delegates. From this point on, any
updates to the requesting user's presets will result in
.B DD=
commands sent to all delegates as well.
The JSON payload includes:
.RS
'\" <<list>>
.TP
.B For
The user for whom these delegates are being defined. If empty or
missing, the default is to define them for the requesting user.
Only the GM may set delegates for someone else.
.TP
'\" <</ital-is-var>>
.BI "Delegates " "(list of strings)"
'\" <<ital-is-var>>
The list of usernames who are allowed to access the requesting user's
die-roll presets. This replaces the previous set of delegates. If the list
is empty (or the
.B Delegates
field missing), then all delegates are removed.
.RE
'\" <</>>
.TP
.B DENIED
Access to the server is denied. The server will send this to a client; clients
MAY NOT send it. 
When a client receives this message, it MUST not continue
to communicate with the server. In fact, the server SHOULD terminate the
network connection after sending the
.B DENIED
message.
The JSON payload sent with this command includes the field:
'\" <<list>>
.RS
.TP
.B Reason
Text description of why the access was refused.
'\" <</>>
.RE
.TP
.B DR
Retrieve the authenticated user's die roll presets. This SHOULD
result in the server sending the
.B DD=
command back to the requesting client. 
The JSON payload may contain the following field:
.RS
'\" <<list>>
'\" <<New>>
.TP
'\" <</ital-is-var>>
.BI Global " (bool)"
If present and true, this requests a list of only the global, system-wide set of presets rather than all of the presets the client should 
know about.
'\" <</New>>
'\" <<ital-is-var>>
.TP
.B For
The name of the user whose presets are being requested.
Only the GM or an authorized delegate may request other users' presets.
If this field is empty or missing, the requesting user's presets are requested.
'\" <</>>
.RE
.TP
.B DSM
Defines (or re-defines) a condition status marker which the client SHOULD
use to mark creature tokens when the creature has the associated condition in
effect. The JSON payload includes the following fields:
'\" <<list>>
.RS
.TP
.B Condition
The name of the condition being described.
If there was already a marker defined for that condition, it is replaced with the new
definition. If either 
.B Shape
or
.B Color
is the empty string or
.BR null ,
then the condition is effectively removed from the list of conditions
known to the mapper. Creature conditions are in effect if their name appears in the list value
for that creature's 
.B StatusList
attribute.
The mapper comes with the following conditions pre-defined:
.BR "ability damage" ,
.BR "ability drained" ,
.BR bleed ,
.BR blinded ,
.BR confused ,
.BR cowering ,
.BR dazed ,
.BR dazzled ,
.BR dead ,
.BR deafened ,
.BR disabled ,
.BR dying ,
.BR "energy drained" ,
.BR entangled ,
.BR exhausted ,
.BR fascinated ,
.BR fatigued ,
.BR flat-footed ,
.BR frightened ,
.BR grappled ,
.BR helpless ,
.BR incorporeal ,
.BR invisible ,
.BR nauseated ,
.BR panicked ,
.BR paralyzed ,
.BR petrified ,
.BR pinned ,
.BR poisoned ,
.BR prone ,
.BR shaken ,
.BR sickened ,
.BR stable ,
.BR staggered ,
.BR stunned ,
and
.BR unconscious .
.TP
.B Shape
The shape of the marker to be placed if the creature has this condition.
The mapper will attempt to arrange multiple markers with the same shape such
that they are all visible at the same time. This value may be one of the 
'\" <<TeX>>
'\"symbols shown in Table~\ref{tbl:manpages:mapper:6:conditions}.
'\"\begin{table}
'\" \begin{center}
'\"  \begin{tabular}{lp{4in}}\toprule
'\"   \bfseries Symbol & \bfseries Description of Indicator \\\midrule
'\"    \z{|v} & A small downward-pointing triangle against the middle of the left edge of the token.
'\"             (This is a lower-case ``\z{v}''.)\\
'\"    \z{v|} & A small downward-pointing triangle against the middle of the right edge of the token.
'\" (This is a lower-case ``\z{v}''.)\\
'\"    \z{|o} & A small circle against the middle of the left edge of the token.
'\" (This is a lower-case ``\z{o}''.)\\
'\" \z{o|} & A small circle against the middle of the right edge of the token.
'\" (This is a lower-case ``\z{o}''.)\\
'\" \z{|<>} & A small diamond against the middle of the left edge of the token.\\
'\" \z{<>|} & A small diamond against the middle of the right edge of the token.\\
'\" \z{/} & A slash (upper right to lower left) through the entire token.\\
'\" \z{\textbackslash} & A back-slash (upper left to lower right) through the entire token.\\
'\" \z{//} & A double slash (upper right to lower left) through the entire token.\\
'\" \z{\textbackslash\textbackslash} & A double back-slash (upper left to lower right) through the entire token.\\
'\" \z{-} & A single horizontal line drawn through the center of the entire token.\\
'\" \z{=} & A double horizontal line drawn through the center of the entire token.\\
'\" \z{|} & A single vertical line drawn through the center of the entire token.\\
'\" \z{||} & A double vertical line drawn through the center of the entire token.\\
'\" \z{+} & A cross drawn through the entire token.\\
'\" \z{\#} & A hash-mark drawn through the entire token.\\
'\" \z{V} & A large downward triangle drawn around the entire token.  (This is an upper-case letter ``\z{V}''.)\\
'\" \z{\textasciicircum} & A large upward triangle drawn around the entire token.\\
'\" \z{<>} & A large diamond drawn around the entire token.\\
'\" \z{O} & A large circle drawn around the entire token. (This is an upper-case letter ``\z{O}''.)\\
'\" \bottomrule
'\" \end{tabular}
'\" \caption{Condition Marker Symbols\label{tbl:manpages:mapper:6:conditions}}
'\" \end{center}
'\"\end{table}
following:
.RS
.\" <<desc>>
.TP
.B |v
A small downward-pointing triangle against the middle of the left edge of the token.
(This is a lower-case \*(lqv\*(rq.)
.TP
.B v|
A small downward-pointing triangle against the middle of the right edge of the token.
(This is a lower-case \*(lqv\*(rq.)
.TP
.B |o
A small circle against the middle of the left edge of the token.
(This is a lower-case \*(lqo\*(rq.)
.TP
.B o|
A small circle against the middle of the right edge of the token.
(This is a lower-case \*(lqo\*(rq.)
.TP
.B |<>
A small diamond against the middle of the left edge of the token.
.TP
.B <>|
A small diamond against the middle of the right edge of the token.
.TP
.B /
A slash (upper right to lower left) through the entire token.
.TP
.B \e
A back-slash (upper left to lower right) through the entire token.
.TP
.B //
A double slash (upper right to lower left) through the entire token.
.TP
.B "\e\e"
A double back-slash (upper left to lower right) through the entire token.
.TP
.B \-
A single horizontal line drawn through the center of the entire token.
.TP
.B =
A double horizontal line drawn through the center of the entire token.
.TP
.B |
A single vertical line drawn through the center of the entire token.
.TP
.B ||
A double vertical line drawn through the center of the entire token.
.TP
.B +
A cross drawn through the entire token.
.TP
.B #
A hash-mark drawn through the entire token.
.TP
.B V
A large downward triangle drawn around the entire token.
(This is an upper-case letter \*(lqV\*(rq.)
.TP
.B ^
A large upward triangle drawn around the entire token.
.TP
.B <>
A large diamond drawn around the entire token.
.TP
.B O
A large circle drawn around the entire token.
(This is an upper-case letter \*(lqO\*(rq.)
.RE
.\" <</>>
'\" <</TeX>>
.TP
.B Color
The color to draw the marker in any of the forms documented
above, or the special value
.RB \*(lq * \*(rq,
which means to draw the marker in the same color as the creature's
threatened area.
.RS
.LP
If 
.I color
begins with 
.RB \*(lq \-\- \*(rq
(e.g., 
.RB \*(lq \-\-red \*(rq),
then the marker is drawn with dashed lines instead of solid ones.
If it begins with
.RB \*(lq .. \*(rq
(e.g., 
.RB \*(lq ..blue \*(rq),
then the effect is the same, but the dashes are shorter.
.RE
.TP
'\" <</ital-is-var>>
.BI Transparent " (bool)"
'\" <<ital-is-var>>
If true, the creature token should be displayed in a semi-transparent
form whenever it has this condition
(added in protocol 404).
.TP
.B Description
A description of the effects on the character of having that condition
applied. This is intended to be shown to players (for example,
if they hover their mouse over an affected creature token).
'\" <</>>
.RE
.TP
.B ECHO
Ask that the server send this message back to you. This may be used
for synchronization since it indicates to the client when the server
got to this request amongst the others it received. The following
fields may be populated:
.RS
'\" <<list>>
.TP 12
.B s
An arbitrary string value.
.TP
'\" <</ital-is-var>>
.BI "i " (int)
An arbitrary integer value.
.TP
.BI "b " (bool)
An arbitrary boolean value.
.TP
.BI "o " (object)
An arbitrary set of key/value pairs, with each value having any type.
.LP
The server will also populate the following additional fields in its reply, which
a client can use to calculate the round-trip time for the request and identify
how much of that was internal to the server and how much was network latency.
.TP
.BI "ReceivedTime " "(RFC 3339-formatted datetime string)"
The time when the server received the packet from the client.
.TP
.BI "SentTime " "(RFC 3339-formatted datetime string)"
The time when the server sent the response packet to the client.
'\" <<ital-is-var>>
.RE

'\" <</>>
'\" <<New>>
.TP
.B FAILED
Gives notice that a client request was not accepted. This may be issued by the server
for reasons such as an error in the request itself that the server is able to detect
before processing it further, or it may originate from a GM client in response to a player
request such as
.B TMRQ
where the request contains an error or the GM decides to decline the request.
If this message is sent by a client, it MUST be a privileged client, and will be relayed
to the indicated requesting client.
The JSON payload includes the following fields:
.RS
.TP
'\" <</ital-is-var>>
.BI "IsError " (bool)
If true, this notice indicates that the request failed because it contains an error that prevents it from being
carried out.
.TP
.BI "IsDiscretionary " (bool)
If true, this notice is the result of a decision by the GM to decline the player's request.
'\" <</ital-is-var>>
.TP
.B Command
The original command being referenced.
.TP
.B Reason
Freeform text describing why the request failed or was declined. This should be all that needs to be shown to the end user to explain the issue.
.TP
.B RequestID
The uniquie identifier sent along with the original request.
.TP
.B RequestedBy
The user name of the original requester.
.TP
.B RequestingClient
The client ID of the original requester. When the
.B FAILED
message is sent by a GM client, the server will relay it to this client session.
.RE
'\" <</New>>
.TP
.B GRANTED
Access to the server is granted. The server will send this to a client; no client should send it. The JSON payload contains the field:
'\" <<list>>
.RS
.TP
.B User
The user name for this client. This is the name provided by the client,
.RB \*(lq anonymous \*(rq 
if the client didn't give one, or 
.RB \*(lq GM \*(rq 
if the
client authenticated as the GM.
'\" <</>>
.RE
'\" <<New>>
.TP
.B HPACK
Acknowledge a hit point change request made via a previous
.B HPREQ
message. The JSON payload for this message has the following fields:
.RS
'\" <<list>>
.TP
.B RequestID
The ID of the original request, as sent by the client when making it.
.TP
.B RequestingClient
The client connection ID as it appeared in the original request.
.TP
.B RequestedBy
The user name of the original requester. If the server is unable to locate the original requesting client connection as
specified by the
.B RequestingClient
field, it MAY send
.B HPACK
messages to clients logged in by the user named in this field instead.
'\" <</>>
.RE
.TP
.B HPREQ
Request an update to a target creature's hit points. This request will be sent to the GM for approval. If the GM
approves, the creature's hit points will be amended in the system and will be reflected as appropriate in the
tracking information sent by the server. The client SHOULD also receive a corresponding
.B HPACK
message acknowledging this request.
Clients
MUST cope with the possibility of not receiving those acknowledgement messages
or there being long delays between the request and acknowledgement.
If
the GM declines to accept the request, or if the request contains an
error, a 
.B FAILED 
message SHOULD be sent back to the requesting client with the
same 
.B RequestID 
value as the original request.
.RS
The JSON payload for this message includes the following fields:
.TP
'\" <<list>>
.B Target
The name of the creature as it appears on the map.
.TP
.B RequestedBy
The user name of the user who initiated this request. Clients NEED NOT
supply this field; it will be supplied by the server as it relays the request on
to the GM.
.TP
.B RequestingClient
The client connection ID of the user who initiated this request. Clients
MUST NOT supply this field; it will be supplied by the server as it relays
the request on to the GM. The meaning of this value is opaque and is only
used by the server.
.TP
.B RequestID
A unique identifier for this request. Replies sent back to the requesting
client in regard to this request will reference this same ID. A UUID string
is suggested for this value.
.TP
'\" <</ital-is-var>>
.BI Healh " (object)"
The health object values you wish to set. The only values which will be considered
for this request are:
.RS
'\" <<list>>
.TP
.BI MaxHP " (int)"
The creature's maximum number of hit points.
.TP
.BI TmpHP " (int)"
The creature's temporary hit points beyond their maximum.
.TP
.BI LethalDamage " (int)"
The amount of lethal damage sustained.
.TP
.BI NonLethalDamage " (int)"
The amount of non-lethal damage sustained.
'\" <</>>
'\" <<ital-is-var>>
.RE
.RE
'\" <</>>
'\" <</New>>
.TP
.B I
Update the time clock for initiative-based actions.  If the mapper
is in combat mode, the clock display is updated accordingly.
The JSON object payload includes the following fields:
'\" <<list>>
.RS
.TP
.B ActorID
The object identifier of the creature whose turn it is. This may
be the unique object ID code, the creature name as documented in the
.B AC
command, the special string
.RB \*(lq *Monsters* \*(rq
which indicates that all creatures with monster-type tokens have
initiative, or may be of the form
.BI \fR\*(lq\fP/ regex \fR\*(rq,\fP
which matches all creatures whose names match the regular expression
.IR regex .
.TP
'\" <</ital-is-var>>
.BI Hours " (int)"
The number of hours elapsed since the start of combat.
.TP
.BI Minutes " (int)"
The number of minutes elapsed since the start of this hour of combat.
.TP
.BI Seconds " (int)"
The number of seconds elapsed since the start of this minute of combat.
.TP
.BI Rounds " (int)"
The number of rounds elapsed since the start of combat.
.TP
.BI Count " (int)"
'\" <<ital-is-var>>
The number of initiative slots elapsed since the start of the round.
'\" <</>>
.RE
.TP
.B IL
Update the initiative list.
The JSON payload includes the following field:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI InitiativeList " (list of objects)"
The current initiative list is given as a list of initiative slots, each of which
is an object with the following fields:
'\" <<list>>
.RS
.TP
.BI Slot " (int)"
The slot number. As currently implemented this is a number in the range [0,59] which
gives the \*(lqcount\*(rq (1/10th second) in the round where this creature may act.
.TP
.BI CurrentHP " (int)"
The creature's current hit point total.
.TP
.BI Name
The creature's name as displayed on the map.
.TP
.BI IsHolding " (bool)"
If true, the creature is holding their action.
.TP
.BI HasReadiedAction " (bool)"
If true, the creature is holding a readied action.
.TP
.BI IsFlatFooted " (bool)"
'\" <<ital-is-var>>
If true, the creature is flat-footed.
'\" <</>>
.RE
'\" <</>>
.RE
.TP
.B L
Loads map elements into the map client, either replacing or adding to the
current contents of the map. Supersedes the function of commands
.BR L ,
.BR M ,
.BR M? ,
and
.B M@
in protocol versions prior to 400.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.B File
The local pathname or server ID identifying the map file to be loaded.
.TP
'\" <</ital-is-var>>
.BI IsLocalFile " (bool)"
If true, 
.B File
refers to a local filename; otherwise it is a server ID.
.TP
.BI CacheOnly " (bool)"
If true, the server is only advising the client that it would be good to have
a cached copy of the
file
on hand for later. The client MUST NOT actually load the file's contents to the
displayed map at this time.
.TP
.BI Merge " (bool)"
'\" <<ital-is-var>>
If true, the map elements in
.B File
are merged with the map's current contents. Otherwise the map's current
elements are replaced by the new ones in
.BR File .
.RE
'\" <</>>
.TP
.BI LS- type
This set of commands
load a single map element into the map.
As opposed tothe
.B L
command which directs the client to read a file to get one or more objects,
this just sends an object directly to it. This may be used, for example, when
one client draws an element interactively and wants the other clients to display
it as well.
.RS
.LP
These supersede the function of the commands
.BR LS ,
.BR LS: ,
and
.BR LS.
in protocol versions prior to 400.
.LP
All of the following
.BI LS- type
commands include as many of the following parameters as are applicable
to them, in addition to type-specific parameters:
'\" <<list>>
.TP
.B ID
The unique object identifier. This is a string containing upper- or lower-case
letters, digits, underscores and octothorpes. By convention, we create these
as hexadecimal UUID values, but they may be any arbitrary string, including
human-readable IDs such as \*(lqPC1\*(rq, etc.
.TP
'\" <</ital-is-var>>
.BI X " (float)"
The
.I x
coordinate of the \*(lqreference point\*(rq of the element, in standard map pixel units.
.TP
.BI Y " (float)"
The
.I y
coordinate of the \*(lqreference point\*(rq of the element, in standard map pixel units.
.TP
.BI Points " (list of coordinate objects)"
If an object needs more than a single coordinate pair to specify their
location, (e.g., the diagonally opposite corner of a rectangle)
the subsequent points are listed in this parameter. Each
element in the list is an object with the fields:
'\" <<list>>
.RS
.TP
.BI X " (float)"
The
.I x
coordinate in standard map pixel units.
.TP
.BI Y " (float)"
The
.I y
coordinate in standard map pixel units.
.RE
'\" <</>>
.TP
.BI Z " (int)"
The
.I z
\*(lqcoordinate\*(rq of the element is its vertical stacking order
on the displayed map canvas. Higher numbers are drawn after lower numbers.
If two objects have the same
.I z
value and physically overlap, the result is not defined.
.TP
.BI Line
The color used to draw the shape's outline, as a standard color
name or RGB string such as \*(lq#336699\*(rq.
.TP
.BI Fill
As with the
.B Line
field, specifies a color to fill the interior of the element. If omitted or
empty, the object will not be filled. Note that line objects are
.I filled
with the 
.B Fill
color. They don't have an outline so don't use the
.B Line
value.
.TP
.B Stipple
If nonempty, the value is the name of a bitmap image which is assumed to be known
to the client. The shape will be filled in with the
.B Fill
color using this bitmap to form a stipple pattern in that color. If the
.B Stipple
bitmap is empty or unknown to the client, a solid color fill is used instead. If
the
.B Fill
field is empty, then
.B Stipple
is ignored. Clients SHOULD by default understand stipple bitmap names
.RB \*(lq gray12 \*(rq,
.RB \*(lq gray25 \*(rq,
.RB \*(lq gray50 \*(rq,
and
.RB \*(lq gray75 \*(rq.
.TP
.BI Width " (int)"
The width in pixel units of the element's outline.
.TP
.BI Layer
The map layer this element belongs to. 
'\" <<TeX>>
'\" {\color{red}Currently not implemented by the mapper client.}
Currently not implemented.
'\" <</TeX>>
.TP
.BI Level
The dungeon level where this element appears. 
'\" <<TeX>>
'\" {\color{red}Currently not implemented by the mapper client.}
Currently not implemented.
'\" <</TeX>>
.TP
.BI Group
The object group to which this element belongs.
'\" <<TeX>>
'\" {\color{red}Currently not implemented by the mapper client.}
Currently not implemented.
'\" <</TeX>>
.TP
.BI Dash " (int)"
The outline of the element is to be drawn with the specified dash pattern:
'\" <<desc>>
.RS
.TP 3
0
Solid (the default)
.TP
1
Long dashes
.TP
2
Medium dashes
.TP
3
Short dashes
.TP
4
Long-Short pattern
.TP
5
Long-Long-Short pattern
'\" <</>>
.RE
.TP
.BI Hidden " (bool)"
If true, this element MUST NOT be displayed on-screen.
'\" <<TeX>>
'\" {\color{red}Currently not implemented by the mapper client.}
Currently not implemented by the mapper client.
'\" <</TeX>>
.TP
.BI Locked " (bool)"
If true, this element MUST NOT be edited further by clients.
'\" <<ital-is-var>>
'\" <</>>
.RS
.LP
Each of the following commands which begin with 
.B LS-
defines a different kind of map element.
.RE
.TP
.B LS-ARC
Draws an arc on the canvas. 
The arc is drawn around the circumference
of the ellipse inscribed in the rectangle defined by the reference point and the
first point in the
.B Points
attribute (as opposite corners of a rectangle).
The payload is a JSON object with these parameters in addition to
those common to all map elements:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI ArcMode " (int)"
Specifies how to draw the arc on-screen. 
'\" <<desc>>
.RS
.TP 3
0
Pie slice (default); connects the arc endpoints to the center of the circle.
.TP
1
Arc; does not connect the endpoints to anything else.
.TP
2
Chord; connects the endpoints to each other via a straight line segment.
'\" <</>>
.RE
.TP
.BI Start " (float)"
The number of degrees around the circle to begin drawing the arc.
.TP
.BI Extent " (float)"
The number of degrees around the circle to end drawing the arc.
'\" <</>>
.RE
.TP
.B LS-CIRC
Draws an ellipse on the map canvas.
The payload is a JSON object as described for all map elements above.
The ellipse is defined as described for the 
.B LS-ARC
command, but the entire circumference is drawn.
.TP
.B LS-LINE
Draws a straight line segment from the reference point to the
each point in the
.B Points
attribute (if more than one point is in
.B Points
the result will be multiple connected line segments).
The JSON payload has the following attribute in addition to the common
ones described above:
'\" <<list>>
.RS
.TP
.BI Arrow " (int)"
The style of arrows to draw on the ends of the line:
'\" <<desc>>
.RS
.TP 3
0
No arrows
.TP
1
Arrow on the first point (the reference)
.TP
2
Arrow on the last point
.TP
3
Arrows on both first and last points
'\" <</>>
.RE
'\" <</>>
.RE
.TP
.B LS-POLY
Draws a polygon on the map canvas. The vertices of the polygon
start at the reference point and continue through every point in
the 
.B Points
attribute, and finally connecting back to the reference
point again. The JSON payload contains
the following fields in addition to the common ones described
above:
'\" <<list>>
.RS
.TP
.BI Spline " (int)"
The factor to use when smoothing the sides of the polygon
between its points. 0 means not to smooth at all, resulting
in a shape with straight edges between the vertices. Otherwise,
larger values provide more smoothing.
.TP
.BI Join " (int)"
The join style for the edges of the polygon:
'\" <<desc>>
.RS
.TP 3
0 
Beveled corners
.TP
1
Mitered corners
.TP
2
Rounded corners
'\" <</>>
.RE
'\" <</>>
.RE
.TP
.B LS-RECT
Draws a rectangle defined by the reference point and the first point
in the 
.I points
attribute (as opposite corners of the rectangle).
.TP
.B LS-SAOE
Draws the zone of a spell's area of effect on the canvas. 
The JSON payload contains the following field in addition to those 
described above:
'\" <<list>>
.RS
.TP
.BI AoEShape " (int)"
The shape of the area of effect:
'\" <<desc>>
.RS
.TP 3
0
Cone: a 90\(de pieslice defined as described for a pieslice arc element.
.TP
1
Radius: an ellipse defined as described for a circle element.
.TP
2
Ray: a rectangle defined as described for rectangle elements.
'\" <</>>
.RE
'\" <</>>
.RE
.TP
.B LS-TEXT
Places some text on the canvas. The JSON payload includes the following
fields in addition to those common to all elements:
'\" <<list>>
.RS
.TP
.B Text
The text to be displayed.
.TP
.BI Font " (object)"
The typeface to use for the text. This is an object with the following
fields:
'\" <<list>>
.RS
.TP
.B Family
The name of the font family as recognized by Tk.
.TP
.BI Size " (float)"
The font size as recognized by Tk.
The client MAY truncate this to an integer if it can't handle fractional point sizes.
.TP
.BI Weight " (int)"
The type wight to use. This may be 0 for normal or 1 for boldface.
.TP
.BI Slant " (int)"
The type slant to use. This may be 0 for Roman (normal) or 1 for Italic (slanted).
.RE
'\" <</>>
.TP
.BI Anchor " (int)"
Where the reference point is considered to be relative to the text:
'\" <<desc>>
.RS
.TP 3
0
Center
.TP
1
North
.TP
2
South
.TP
3
East
.TP
4
West
.TP
5
Northeast
.TP
6
Northwest
.TP
7
Southwest
.TP
8
Southeast
.RE
'\" <</>>
.RE
'\" <</>>
.TP
.B LS-TILE
Draws an image tile on the canvas. The JSON payload has the following
fields in addition to those common to all map elements:
'\" <<list>>
.RS
.TP
.B Image
The image name as known to the mapper.
.TP
.BI BBHeight " (float)"
The bounding-box height for the region bordering the image.
.TP
.BI BBWidth " (float)"
'\" <<ital-is-var>>
The bounding-box width for the region bordering the image.
'\" <</>>
.RE
.TP
.B MARCO
Status check. If received, reply with a 
.B POLO
command.
Clients MUST NOT send this command.
.RS
.LP
'\" <</bold-is-fixed>>
.B N.B.
'\" <<bold-is-fixed>>
It is important that your client not ignore these occasional ping messages.
For example, if your client is too slow receiving messages such that the
server needs to expend extra work to queue them up for you, it will be
willing to do so if you have been at least responding to
.B MARCO
messages. If you haven't, the server will suspect your client has locked up
or is not going to be able to catch up with the data being sent to it, and
may decide to terminate the client's connection.
.RE
.TP
.B MARK
Make a brief animated marker at the specified coordinates to draw attention
to that space. The JSON payload contains the following fields:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI X " (float)"
The
.I x
coordinate of the marker.
.TP
.BI Y " (float)"
The 
.I y
'\" <<ital-is-var>>
coordinate of the marker.
'\" <</>>
.RE
.TP
.B OA
Updates attributes of a specified map object. Any attributes not listed in the
command MUST remain as-is. The JSON payload includes the following fields:
'\" <<list>>
.RS
.TP 
.B ObjID
The unique object identifier for the object to be modified.
Alternatively, it may be in the form
.BI @ name
where
.I name
is the creature's name in any of the forms allowed for the 
.B AC
command.
.TP
'\" <</ital-is-var>>
.BI NewAttrs " (object)"
'\" <<ital-is-var>>
The set of new attributes and their values, expressed as an object with
field names matching the object attributes to be changed and their associated
values being the new values for those attributes.
'\" <</>>
.LP
Example: 
.B "OA {\[dq]ObjID\[dq]:\[dq]a984a3\[dq],\[dq]NewAttrs\[dq]:{\[dq]X\[dq]:12,\[dq]Y\[dq]:44.5}}"
.LP
Note that there was an implicit assumption in the past that the
.B Name
attribute of a creature would not change and it could be used as an immutable identifier
within a map client for a creature token. However, this is not the case and
in fact GMA now includes explicit features to change this very attribute.
Clients must be prepared to deal with the consequences of a change to any
attribute, including
.BR Name .
The 
.B mapper
client itself does this correctly starting with version 3.39.
.RE
.TP
.B OA+
Adds one or more values to a single attribute of an object known to the mapper.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.BI ObjID
The unique object identifier, specified as for the
.B OA
command.
.TP
.BI AttrName
The name of the attribute to be modified. This MUST be an attribute
whose value is a list of strings. (E.g., the 
.B StatusList
attribute of creature objects.)
.TP
'\" <</ital-is-var>>
.BI Values " (list of strings)"
'\" <<ital-is-var>>
A list of string values to be added to those already in the named attribute.
.RE
'\" <</>>
.TP
.B OA\-
Removes one or more values from a single attribute of an object known to the mapper.
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.BI ObjID
The unique object identifier, specified as for the
.B OA
command.
.TP
.BI AttrName
The name of the attribute to be modified. This MUST be an attribute
whose value is a list of strings. (E.g., the 
.B StatusList
attribute of creature objects.)
.TP
'\" <</ital-is-var>>
.BI Values " (list of strings)"
'\" <<ital-is-var>>
A list of string values to be removed from those already in the named attribute.
It is not an error if the value wasn't there to begin with.
.RE
'\" <</>>
.TP
.B OK
The server sends this to the client when it is ready for the client to start
sending commands to it. The accompanying JSON payload includes the following
fields:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Protocol " (int)"
The protocol version used by the server. Map clients which do not support
that protocol SHOULD warn their users and SHOULD disconnect since they can't
guarantee they can actually communicate with the server.
.TP
.BI Challenge " (base64-encoded bytes)"
If present, the
.B Challenge
value is a base-64-encoded authentication challenge. A client must successfully
respond with a valid
.B AUTH
command before any of its commands to the server will be accepted. The server will also
refuse to send the client any map updates until it has successfully authenticated.
'\" <<New>>
.TP
.BI Iterations " (int)"
The number of rounds of hashing to apply to generate the challenge response. This
value SHOULD be in the range [64,4095].
'\" <</New>>
.TP
.BI ServerStarted " (RFC 3339-formatted datetime string)"
The absolute wall-clock time that the server was started.
.TP
.BI ServerActive " (RFC 3339-formatted datetime string)"
The abolute wall-clock time of the server's last
.B MARCO
ping signal. If this was long ago (more than a minute or two with out-of-the-box
server configuration), it is an indicator that the server's main event loop is deadlocked.
.TP
.BI ServerTime " (RFC 3339-formatted datetime string)"
The current wall-clock time on the server. This provides an accurate point of reference
to determine how long ago the other server time values occurred.
.TP
.B ServerVersion
The server's version number.
(Added in protocol 405.)
'\" <<ital-is-var>>
'\" <</>>
.RE
.TP
.B PRIV
Notice from the server that a command sent by the client is denied due to
insufficient privilege. Clients MUST NOT send this command. The JSON
payload includes the following fields:
'\" <<list>>
.RS
.TP
.B Command
The command the client was attempting.
.TP
.B Reason
The reason that command was denied.
'\" <</>>
.RE
.TP
.B POLO
No-op. Clients MUST ignore if received. Clients SHOULD send this in response
to a
.B MARCO
command from the server.
.TP
.B PROGRESS
The server sends this to the client to 
indicate progress of a long-running operation such as downloading files.
(Formerly this was sent as a comment prior to protocol version 400.)
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.B OperationID
A unique identifier for the operation we're reporting progress for.
.TP
'\" <</ital-is-var>>
.BI "Targets " (list)
If this progress bar is associated with a specific character or characters, they are listed by name here.
.TP
.BI "IsTimer " (bool)
If true, this is showing the status of a running timer instead of an operation in progress.
'\" <</>>
.TP
.B Title
The description of the operation in progress. This is suitable for display to the user.
.TP
.BI Value " (int)"
The current value of the progress meter. Units are arbitrary.
The value may fluctuate up or down over the course of the updates that are received.
It may also go negative. It is up to the client to display negative values appropriately
based on the type of progress meter or other context. For example, timers generated by
GMA will run negative for a number of updates to show that the timer has expired before
sending a final update with
.B IsDone
true to indicate that the timer should be removed from view.
.TP
.BI MaxValue " (int)"
The maximum value expected for the progress meter when it is finished.
If this is 0, we don't yet know what the maximum will be, which SHOULD cause
the client to use a progress meter style that indicates that it is not possible
to estimate remaining time to completion. Also note that this value MAY change
over the course of the progress report if the server becomes aware that it has
a better maximum value available to it at that point.
.TP
.BI IsDone " (bool)"
'\" <<ital-is-var>>
A boolean indication that the operation is completed. The client SHOULD remove the
progress meter from display when the operation is completed.
'\" <</>>
.LP
Clients SHOULD NOT send these; they are for the server to notify the client
about progress. If a client does send progress update messages to other
peers, it should be clear that what is being tracked is a process that the
other clients are interested in.
.LP
'\" <<New>>
As a special case, the server may send this message with
.B OperationID=*
and
.BR IsDone=true .
This is a signal to clients that all timers should be cancelled and dismissed from view.
If a subsequent
.B PROGRESS
message is sent with the
.B OperationID
of a timer that was dismissed in this way, clients should treat it like a new
timer being created at that point.
'\" <</New>>
.RE
'\" <<list>>
.TP
.BI PS
Place a creature token on the map. This may be used to define a new creature object
if no object with the given
.I ID
already exists, or replaces an existing token with the (possibly different) parameters
given. The JSON payload includes the following fields:
.RS
'\" <<list>>
.TP 
.B ID
The internal ID by which this creature is to be known. This must be unique. The client
which creates the character token locally should create a unique ID, which is then broadcast
via this command to the other clients, which use the same ID.
.TP
.B Name
The name as displayed on the map. Must be unique among all creatures
currently displayed.
.TP
'\" <</ital-is-var>>
.BI Health " (object)"
If not
.BR null ,
this gives the current health status of the creature. It is an object with the
following fields:
'\" <<list>>
.RS
.TP
.BI MaxHP " (int)"
The creature's maximum number of hit points.
'\" <<New>>
.TP
.BI TmpHP " (int)"
The creature's temporary hit points, in addition to their maximum.
'\" <</New>>
.TP
.BI LethalDamage " (int)"
The amount of lethal damage sustained.
.TP
.BI NonLethalDamage " (int)"
The amount of non-lethal damage sustained.
.TP
.BI Con " (int)"
The grace amount of hit points the creature may sustain over their maximum
before they are considered dead.
.TP
.BI IsFlatFooted " (bool)"
If true, the creature is flat-footed.
.TP
.BI IsStable " (bool)"
If true, the creature has been stabilized to prevent death while critically wounded.
Creatures which are in non-critical states of health don't have this attribute set
even though technically (in a sense) they are \*(lqstable\*(rq.
.TP
.BI Condition
A custom condition status to display on the map, if you wish to override the map's
calculation.
.TP
.BI HPBlur " (int)"
If 0, the creature's health is displayed accurately. Otherwise, this gives
the percentage by which to \*(lqblur\*(rq the hit points as seen by the 
players. For example, if
.B HPBlur
is 10, then hit points are displayed only in 10% increments.
'\" <</>>
.RE
.TP
'\" <</ital-is-var>>
.BI Hidden " (bool)"
If true, this creature token is hidden from player view, although the GM can still see it.
Added in protocol 404.
.TP
.BI Gx " (float)"
The grid 
.I x
coordinate for the creature's reference point. Note that this is in
grids, not pixel units.
.TP
.BI Gy " (float)"
The grid 
.I y
coordinate for the creature's reference point. Note that this is in
grids, not pixel units.
.TP
.BI PolyGM " (bool)"
If true, only the GM may access the polymorph capabilities of this creature.
Map clients not logged in as GM MUST not display any information indicating
that there are different skins available, nor allow the user to select among them.
.TP
.BI Skin " (int)"
If 0, show the default appearance on the creature's token. Otherwise, show
one of the alternative images defined for that creature.
.TP
.BI SkinSize " (list of strings)"
This gives a list of values to use for the
.B Size
attribute corresponding to the
.B Skin
number. For example, if there are 3 skins defined for a
shape-changing creature, and the first two are medium-size
but the third is large, then 
.B SkinSize
would have a value like
.BR [\[dq]M:base\[dq],\[dq]M:disguise\[dq],\[dq]L:giant\[dq]] .
.TP
.BI Elev " (int)"
The creature's elevation in feet relative to the \*(lqfloor\*(rq level.
.TP
.BI Color
The color code used to draw the creature's threat zone.
.TP
.BI Note
A note to attach to the creature token to indicate special conditions or status.
.TP
.BI Size
The tactical size category of the creature.
'\" <<ital-is-var>>
This has the general form
.RS
.RS
.LP
.IR category [ natural ][\fB->\fP extended ][\fB=\fP space ][\fB:\fP[\fB*\fP] comment ]
.RE
'\" <<TeX>>
'\" \label{gma-mapper-protocol:PS:Size}
'\" <</TeX>>
.LP
where
.I category
is a single-letter category code,
.I natural
is a custom natural reach distance in feet (if different than the standard for that size category),
.I extended
is a custom extended reach distance in feet (if different than the standard for that size category),
and
.I space
is a custom creature space diameter in feet (if different than the standard for that size category).
(Changed in protocol 406.)
.LP
This is now DEPRECATED. If present and the
.B SkinSize
field is also present, then the value of
.B Size
MUST equal the value of the first element of
.BR SkinSize .
The preferred usage going forward is to not set the
.B Size
field at all, and just use
.B SkinSize
alone. If there is only one skin for the creature, this value will have only a single value.
.RE
'\".TP
'\".BI Area
'\"The tactical size category for the creature's threat zone.
.TP
.B DispSize
If non-empty, this indicates that the creature is temporarily resized
to the given size category and should be displayed as such.
The value is otherwise identical to
.BR Size .
(Added in 406.)
.TP
'\" <</ital-is-var>>
.BI StatusList " (list of strings)"
A list of condition codes which apply to the character. These are defined by
the
.B DSM
command (q.v.).
.TP
.BI AoE " (object)"
If not
.BR null ,
a spell area of effect should be drawn around the creature.
The value is an object with these fields:
'\" <<list>>
.RS
.TP
.BI Radius " (float)"
The distance in standard map pixel units away from the creature's center
to the perimeter of the area of effect.
.TP
.BI Color
The color with which to draw the spell area.
.RE
'\" <</>>
.TP
.BI MoveMode " (int)"
The mode of locomotion currently employed by the creature:
'\" <<desc>>
.RS
.TP 3
0
Land (walking)
.TP
1
Burrowing
.TP
2
Climbing
.TP
3
Flying
.TP
4
Swimming
'\" <</>>
.RE
.TP
.BI Reach " (int)"
Indicates if the creature is wielding a reach weapon and thus has an expanded
threat zone. If 0, the threat zone is normal for the creature. If 1, it cannot
attack adjacent foes but has a wider threat space. If 2, it has both threat
zones active at the same time.
.TP
.BI Killed " (bool)"
If true, the creature is dead.
.TP
.BI Dim " (bool)"
If true, the creature does not have initiative now, and their token
should be de-emphasized compared to the one with initiative.
.TP
.BI CreatureType " (int)"
'\" <<ital-is-var>>
The specific type of creature. This may be 0 if the type is unknown, 1 for
monsters, or 2 for players. Clients MUST NOT set this field to a value other
than 1 or 2.
.TP
'\" <</ital-is-var>>
.BI CustomReach " (object)"
Specify a custom reach distance for this creature, if different than the standard
for a creature of its size category. This contains the following fields:
'\" <<list>>
.RS
.TP
.BI Enabled " (bool)"
If true, there is a custom reach distance as described in the other fields. if false,
the other fields should be ignored.
.TP
.BI Natural " (int)"
The number of feet from the perimeter of the creature token to which the creature's natural
reach extends.
.TP
.BI Extended " (int)"
As
.B Natural
but indicates the distance for reach weapons.
'\" <</>>
.RE
.LP
(Added in protocol 406.)
'\" <</>>
.RE
.TP
.B READY
The server sends this to the client to indicate that all preliminary
data has been sent, authentication (if applicable) has been successful,
and the client may proceed to carry out normal operations now.
.TP
.B REDIRECT
Instructs the client to use a different server for this session. This is used when
the GM wants to use an alternate server temporarily without requiring the players to
reconfigure all their clients.
The server SHOULD send this during the initial stage of client interaction to avoid
authenticating to a server you won't be using and then authenticating to the other one,
but MAY be sent at any point. The client SHOULD disconnect immediately upon receiving
this command, so the rest of the server negotiation may not even happen at all.
The JSON payload includes the following values:
'\" <<list>>
.RS
.TP
.B Host
The host name or IP address of the server to connect to for this session.
.TP
'\" <</ital-is-var>>
.BI "Port " (int)
'\" <<ital-is-var>>
The TCP port number on which to connect to the server.
.TP
.BI Reason
The reason for the redirection to a new server.
'\" <</>>
.LP
This command SHOULD appear before any commands which would alter the client's internal state
such as
.B DSM
or
.BR AC ,
because we cannot guarantee that the client will undo those settings before connecting to the
new server which will send its own set of those commands.  Ideally, when redirecting clients to
a different server,
.B REDIRECT
should be the first item in the server's init file.
.RE
.TP
.B ROLL
Reports the results of a die roll initiated by the
.B D
command. Clients MUST NOT send this command. The JSON payload includes the following fields:
'\" <<list>>
.RS
.TP
.BI Sender
The name of the user who rolled the dice. 
.TP
'\" <</ital-is-var>>
'\" <<New>>
.BI Origin " (bool)"
If present and true upon receipt of this message from the server, this indicates that the client receiving it was the same client who originated the
die roll reqeust whose result is being reported here, as opposed to a client who is merely
being given a copy of the results of another client's die roll.
.TP
.BI Replay " (bool)"
If present and true upon receipt of this message from the server, this indicates that this message is being \*(lqreplayed\*(rq (e.g., as a result
of a
.B SYNC-CHAT
request from the client) and this is not the original sending of the message. As such, the client SHOULD NOT make active responses to it such as
performing lookup table reports on it.
'\" <</New>>
.TP
.BI Recipients " (list of strings)"
The names of the people the message was explicitly addressed to. For
global messages, this should be
.BR null .
.TP
.BI MessageID " (int)"
The unique number assigned by the server for this chat message. (Die roll
results are essentially a kind of chat message.) 
.TP
.BI MoreResults " (bool)"
If true, there will be more
.B ROLL
messages yet to come which are part of the result set for the same die roll
request.
.TP
.B RequestID
The 
.B RequestID
string passed by the client when requesting this die roll, or the empty string
if they didn't.
.TP
.BI Sent " (RFC 3339-formatted datetime string)"
The date and time the message was sent.
Clients SHOULD NOT set a nonempty value for this field. It will be filled in by the server when sending
messages to clients. If this field is missing or empty when received from the server,
it means the date was not available to report for that message.
Note that the special value
.RB \*(lq "0001-01-01T00:00:00Z" \*(rq
is the \*(lqzero\*(rq value for dates and indicates that the date is not known (as is the case if this
field is omitted entirely or is the empty string).
.TP
.BI ToAll " (bool)"
If true, this is a global message sent to all clients.
The contents of the
.B Recipients
field are ignored; it should be omitted or set to
.BR null .
.TP
.BI ToGM " (bool)"
If true, this message will be sent only to the GM. 
The contents of the
.B Recipients
field are ignored; it should be omitted or set to
.BR null .
.TP
.BI Title
The title describing the purpose of the die-roll as set by the
user, if any.
The title string may include special formatting codes which will be used by
clients supporting the
.B DICE-COLOR-BOXES
optional feature (see the
.B ALLOW
command for details). Clients which did not request this feature will not
see the special formatting codes in the title string.
.TP
.BI Result " (object)"
The result of the die roll. This is an object with the following fields:
'\" <<list>>
.RS
.TP
.BI Result " (int)"
The final numerical result of the die-roll.
.TP
.BI InvalidRequest " (bool)"
If true, the die roll never happened because the request could not be understood.
In this case, the details about the request and reason for failure are in the
.B Details
array. The
.B Result
integer field should be disregarded since there was no result generated.
.TP
.BI ResultSuppressed " (bool)"
If true, this result message describes a die roll request without disclosing the
results of the roll. This is used, for example, when sending a die roll for the
GM to see privately (not even showing the requester the result).
In this case, the value of the
.B Result
field should be ignored.
.TP
.BI Details " (list of objects)"
The details behind how that result was generated are given as a list of objects
with the following fields:
'\" <<list>>
.RS
.TP
.BI Type
A text label describing what the value means in the context of the die-roll
result.
.TP
.BI Value
The value for this part of the result (as a string).
'\" <</>>
.RE
'\" <</>>
.RE
'\" <</>>
'\" <<ital-is-var>>
.RE
.TP
.B SYNC
This command MUST be ignored if received by a client. A client sends this to the
server to request a replay of map commands which would be necessary to catch it
up to the state the other maps are currently in.
A server may be configured to perform a sync operation upon client connection (after, if 
required, authentication) without the client explicitly sending a
.B SYNC
command to it.
.TP
.B SYNC-CHAT
This command MUST be ignored if received by a client. 
Supersedes the 
.B SYNC
command with
.B CHAT
argument in protocol versions prior to 400.
A client sends this to the
server to request a replay of chat messages (including die-roll result notices)
according to the JSON payload, which may include this field:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Target " (int)"
'\" <<ital-is-var>>
If missing or 0, all chat messages in the server's history are sent to the client.
Otherwise, if
.B Target
is positive, all messages with 
.BR messageID s
greater than
.BR Target .
If
.B Target
is negative, its absolute value gives the number of recent messages to send
to the client (e.g., if
.B Target
is \-50, then the most recent 50 messages are re-sent to the client).
'\" <</>>
.RE
.TP
.B TB
Controls the display of the toolbar in the mapper client.
The JSON payload is an object with the following field:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Enabled " (bool)"
'\" <<ital-is-var>>
If true, the client SHOULD display its toolbar. If false, the client SHOULD NOT
display it. The client may override this request based on the user's preferences.
'\" <</>>
.RE
'\" <<New>>
.TP
.B TMACK
Acknowledges a timer request. If a client receives this, it means the GM has accepted their
timer request into the set of tracked timers, and subsequent
.B PROGRESS
messages MAY appear as that timer's value is updated over time.
The JSON payload for this message includes the following fields:
.RS
.TP
.B RequestID
The ID of the original request, as sent by the client when making it.
.TP
.B RequestingClient
The client connection ID as it appeared in the original request.
.TP
.B RequestedBy
The user name of the original requester. If the server is unable to locate the original requesting client connection
as specified by the
.B RequestingClient
field, it MAY send
.B TMACK
messages to clients logged in by the user named in this field instead.
.RE
.TP
.B TMRQ
Request a new timer. This sends a request the the GM's GMA client. If the GM approves, the timer
will be added to the collection of timers being tracked for the game. This MAY result in subsequent
.B PROGRESS
messages being received by clients as the timer's value is updated over time. If no GMA process hears
the message, nothing may happen. Clients which receive this message MUST ignore it. If the GM declines
to accept the incoming timer request, or if the request contains an error, a
.B FAILED
message SHOULD be sent back to the requesting client with the same
.B RequestID
value as the original request.
If the GM accepts the timer into the tracking system, their client SHOULD send a
.B TMACK
message with matching
.B RequestID
field to the original requester to notify them of that fact. Clients MUST cope with the possibility
of not receiving those acknowledgement messages or there being long delays between the request and acknowledgement.
.RS
.LP
The JSON payload for this message includes the following fields:
.TP
.B Description
A one-line text description giving the purpose of the timer.
.TP
.B Expires
The time at which the timer should expire. This may be given as an absolute or relative time. If the string begins with
an
.B @
character, it will be an abolute timer and the field MUST have the form
.RS
.LP
.RI \fB@\fP[[[ year \fB-\fP] month \fB-\fP] date "] " hour \fB:\fP minute [\fB:\fP second [\fB.\fP tenths ]]
.LP
where the
.IR year ,
.IR month ,
.IR date ,
.IR hour ,
.IR minute ,
and
.IR second
values are numeric and conform to the campaign world calendar currently in play, and
.I tenths
is a single digit representing tenths of seconds. For example,
.RB \*(lq @15:32 \*(rq
represents a timer which expires at 32 minutes past 3 P.M., and
.RB \*(lq "@10-15 12:00:05" \*(rq
expires at five seconds past noon on the fifteenth day of the tenth month of the current year. Text
names or abbreviations may be used for
.I name
if defined for the calendar in effect at the time, so on the Golarion calendar that last example
could also have been
.RB \*(lq "@LAM-15 12:00:05" \*(rq
since the tenth month is Lamashan.
.LP
Otherwise, the value indicates a relative amount of time from the time and date on the clock at the moment
the timer is accepted into the system by the GM.
This expiration MAY begin with a
.B +
or
.B -
sign. Following this is a number and a unit name, such as
.RB \*(lq "5 rounds" \*(rq
or
.RB \*(lq "3 hours" \*(rq,
or an expression in the form
.LP
.RI [[ days \fB:\fP] hours \fB:\fP] minutes \fB:\fP seconds [\fB.\fP tenths ]
.LP
so
.RB \*(lq "3 hours" \*(rq,
.RB \*(lq "+3 hours" \*(rq,
.RB \*(lq "3:00" \*(rq,
and
.RB \*(lq "+3:00" \*(rq
all set a timer for three hours into the future, while
.RB \*(lq "-2 rounds" \*(rq
sets one that expires two rounds in the past (which may not be as useless as it sounds depending
on the circumstances in the game, but probably is).
.RE
.TP
'\" <</ital-is-var>>
.BI "Targets " "(list of strings)"
If this is empty, the timer is assumed to apply to everyone. Otherwise, it applies to the individuals named in the
list. If these are the names of players, they should match their login names exactly.
.TP
.BI "ShowToAll " (bool)
If true, the timer should be visible to the players. Otherwise, only the GM sees it on their time tracker.
.TP
.BI "IsRunning " (bool)
If true, the timer should start running immediately. Otherwise, the GM will need to manually start it at a future point in time.
.TP
'\" <<ital-is-var>>
.B "RequestedBy"
The user name of the user who initiated this request. Clients NEED NOT supply this field; it will be supplied
by the server as it relays the request on to the GM.
.TP
.B RequestingClient
The client connection ID of the user who initiated this request. Clients MUST NOT supply this field; it will be supplied
by the server as it relays the request on to the GM. The meaning of this value is opaque and is only used by the server.
.TP
.B RequestID
A unique identifier for this request. Replies sent back to the requesting client in regard to this request will reference
this same ID. A UUID string is suggested for this value.
.RE
.RE
'\" <</New>>
.TP
.B TO
Send chat message to a set of recipients. 
The payload is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.BI Sender
The name of the user sending the message. Clients SHOULD NOT set this field; it
is set by the server when sending these messages to peers.
.TP
'\" <</ital-is-var>>
'\" <<New>>
.BI Origin " (bool)"
If present and true upon receipt from the server, this means that the client receiving this message was the same client who sent 
the original message,
instead of merely receiving a copy of the message sent by a peer client. Clients MUST NOT set this field.
.TP
.BI Replay " (bool)"
If present and true upon receipt of this message from the server, this indicates that this message is being \*(lqreplayed\*(rq (e.g., as a result
of a
.B SYNC-CHAT
request from the client) and this is not the original sending of the message. 
'\" <</New>>
.TP
.BI Recipients " (list of strings)"
The names of the people the message was explicitly addressed to. For
global messages, this should be
.BR null .
.TP
.BI MessageID " (int)"
The unique number assigned by the server for this chat message. Clients SHOULD NOT
set this field.
.TP
.BI Sent " (RFC 3339-formatted datetime string)"
The date and time the message was sent.
Clients SHOULD NOT set a nonempty value for this field. It will be filled in by the server when sending
messages to clients. If this field is missing or empty when received from the server,
it means the date was not available to report for that message.
Note that the special value
.RB \*(lq "0001-01-01T00:00:00Z" \*(rq
is the \*(lqzero\*(rq value for dates and indicates that the date is not known (as is the case if this
field is omitted entirely or is the empty string).
.TP
.BI ToAll " (bool)"
If true, this is a global message sent to all clients.
The contents of the
.B Recipients
field are ignored; it should be omitted or set to
.BR null .
.TP
.BI ToGM " (bool)"
If true, this message will be sent only to the GM. 
The contents of the
.B Recipients
field are ignored; it should be omitted or set to
.BR null .
'\" <<New>>
.TP
.BI Markup " (bool)"
If true, the text of this message may contain GMA markup formatting codes which the client SHOULD
either filter out or interpret appropriately for display to the user. If a client did not indicate to the server
that it was capable of understanding these codes via the
.B ALLOW
command (q.v.), then the server will filter out these codes before sending the message to that client.
'\" <</New>>
.TP
.B Text
The text of the message to be sent.
'\" <<ital-is-var>>
.RE
'\" <</>>
.TP
.B /CONN
This command causes the server to send a summary of the
connections it is currently serving. These are sent back to the client
via the
.B CONN
command documented above.
.TP
.B UPDATES
This provides the latest available versions of various programs. A client MAY
alert the user or initiate an automatic upgrade if it recognizes that it or one
of its dependencies is out of date.
Clients MUST NOT send this command.
(Formerly this was sent as a comment prior to protocol version 400.)
The payload contains the following field:
'\" <<list>>
.RS
.TP
'\" <</ital-is-var>>
.BI Packages " (list of objects)"
Each element in this list is a JSON object with the following fields:
'\" <<list>>
.RS
.TP
.B Name
The name of the software package, such as \*(lqmapper\*(rq, \*(lqgo-gma\*(rq, or \*(lqcore\*(rq.
.TP
.B MinimumVersion
If a server wishes to limit clients from this package to only those with a minimum version number
(as self-reported by the client in its
.B AUTH
message), then a
.B MinimumVersion
and
.B VersionPattern
field MUST be added to that package's information here. The
.B MinimumVersion
field is a string with the minimum client version allowed to be used, as a semantic version
string such as
.RB \*(lq 1.2 \*(rq,
.RB \*(lq 1.7.3 \*(rq,
.RB \*(lq 1.6-alpha.1 \*(rq,
etc. This will be matched against the value captured from the client's version number
via the
.B VersionPattern
field.
'\" <</ital-is-var>>
.I "This field should be used only in server init files. Clients SHOULD NOT use this field, nor expect it to be sent by the server."
'\" <<ital-is-var>>
.TP
.B VersionPattern
This gives a regular expression which is matched against the
.B Client
field sent by the client as part of its
.B AUTH
message when signing on to the server. This expression MUST contain a single capturing group
which yields the client's version number to be compared against the
.B MinimumVersion
field described above.
'\" <</ital-is-var>>
.I "This field should be used only in server init files. Clients SHOULD NOT use this field, nor expect it to be sent by the server."
.TP
.BI Instances " (list of objects)"
A list of all available instances of the named package. Each is a JSON object
with the following fields:
'\" <<ital-is-var>>
'\" <<list>>
.RS
.TP
.B OS
The name of the operating system platform for which this instance of the package
is available (e.g., \*(lqfreebsd\*(rq, \*(lqlinux\*(rq, \*(lqdarwin\*(rq, \*(lqwindows\*(rq, etc.).
If this is empty, then this instance is platform-independent.
.TP
.B Arch
The name of the hardware architecture for which this instance of the package
is compiled (e.g., \*(lqamd64\*(rq, etc.) If this is empty, then this instance
is architecture-independent.
.TP
.B Version
The semantic version number that users should be using. This is set by the GM
(or designated server administrator\(emhenceforth we will simply use the term
\*(lqGM\*(rq for this role) for their game. It may not necessarily be
the latest version available generally. The version string MAY omit the third
version number (e.g., 
.RB \*(lq 4.2 \*(rq
instead of the more standards-compliant
.RB \*(lq 4.2.0 \*(rq).
.TP
.B Token
The download token used for obtaining a copy of the package. This is entirely
under the GM's control and refers to a file the GM placed on their game server
for their players to access.  The
.I token
value is the non-static part of the download URL from their game server.
'\" <<ital-is-var>>
.RE
'\" <</>>
.RE
'\" <</>>
.RE
'\" <</>>
.TP
.B "WORLD"
This command provides various campaign-world information useful for the client
to know. Clients MUST NOT send this command. 
The payload includes the following parameters:
'\" <<list>>
.RS
.TP
.B Calendar
The name of the calendar system in play, as known to the GMA game clock.
(Formerly this was sent as a comment in the form
.BI "// CALENDAR // " system
prior to protocol version 400.)

Declares which calendaring system the various dates and times are based upon.
'\" <</ital-is-var>>
.TP
.BI "ClientSettings " (object)
Any of the following settings will override the client's own settings. Clients SHOULD
notify users that this has happened. This allows the GM to make global changes to things
like where images are stored without requiring players to adjust all their settings.
'\" <<list>>
.RS
.TP
.B MkdirPath
The path to the
.B mkdir
program on the server (used for GM uploads of mapper content to the server).
.TP
.B ImageBaseURL
The base URL from which the client will retrieve map and image files.
.TP
.B ModuleCode
The current module's ID code.
.TP
.B SCPDestination
The directory where GM uploads of mapper content should be sent to.
.TP
.B ServerHostname
The hostname (and optionally username in the form
.IB name @ host\fR)\fP
for the GM to upload mapper content to the server.
.RE
'\" <</>>
'\" <<ital-is-var>>
'\" <</>>
.LP
Example:
.B "WORLD {\[dq]Calendar\[dq]:\[dq]golarion\[dq]}"
.RE
'\" <</>>
'\" <<TeX>>
'\" \label{manpage:mapper:6:protocol:end}
'\" <</TeX>>
.SH "SEE ALSO"
.LP
.BR mapper (5),
.BR gma (6),
and
.BR server (6).
.SH AUTHORS
.LP
Steve Willoughby / steve@madscience.zone;
John Mechalas (elevation and movement modes).
.SH HISTORY
'\" <<New>>
.LP
This document defines map protocol version 418,
which adds support for temporary hit point tracking and user requests for hit point changes.
.LP
'\" <</New>>
Version 417 introduced
support for system-wide die-roll presets,
table definitions and markup formatting in chat messages.
It also added the
.B Origin
and
.B Replay
fields to the
.B ROLL
and
.B TO
messages.
'\" <</New>>
.LP
Version 416 added the
.BR FAILED ,
.BR TMRQ ,
and
.B TMACK
messages.
.LP
Version 415 added the 
.B Iterations
parameter to the 
.B OK
message.
.LP
Version 414 changed 
the definition of the
.B DENIED
message to allow it to be sent at any time during the
conversation. 
.LP
Protocol 413
added speculative definitions for the
.BR CORE ,
.BR CORE/ ,
and
.B CORE=
commands, and extensions to the 
.B PROGRESS
command.
.LP
Protocol 412
added support for sharing die-roll presets.
.LP
Protocol 411
added timestamps to chat messages and die-roll results.
.LP
Protocol 410
added the
.B REDIRECT
command and the
.B ClientSettings
field of the
.B WORLD
command.
.LP
Protocol version 409
added the
.B Stipple
pattern fill attribute.
.LP
Protocol version 408 introduced the
.B PolyGM
creature attribute.
.LP
Protocol version 407
added the image animation features.
.LP
Protocol version 406 dropped the
.B Area
attribute from creatures and added the
.B CustomReach
attribute and the expanded syntax for the
.B Size
attribute, as well as the new
.B DispSize
attribute.
.LP
Protocol version 405
introduced the
.B ServerVersion
field to the server's greeting.
.LP
Protocol 404 introduced the
.B Hidden
attribute for creature tokens, the transparent image type,
and the
.B Transparent
attribute for status markers.
.LP
Protocol version 403
introduced the
.B AI/
server message and additional fields to the
.B OK
message.
.LP
Protocol version 402 improved the 
.B ROLL
server message by adding support for blind rolls to the GM.
.LP
Protocol version 401
introduced the
.B Grid
parameter to the
.B AV
command.
.LP
Protocol version 400
changed the server communication protocol to use JSON instead of TCL lists.
It also introduced the
.BR PROGRESS ,
.BR PROTOCOL ,
.BR READY ,
.BR UPDATES ,
and
.B WORLD
commands.
.LP
As of the beta-3 release, the
.B RequestID
and
.B MoreResults
fields were added to die roll requests and results messages.
.LP
Version 332 added the
.B GRANTED
server response, guaranteeing that
.B AUTH
will be followed by a response in any case.
.LP
Version 331
changed the way persistent
chat messages are managed, altering the
.BR ROLL ,
.BR TO ,
.BR SYNC ,
and
.BR CC
commands.
.LP
Version 329 added
the
.B CC
command and the extended form of
.BR SYNC .
.LP
Previously, version 328 introduced
the 
.B ACCEPT
command.
.LP
Version 327 added 
the 
.B DENIED
and
.B PRIV
response commands.
.LP
Version 326 added support
for chat channels and die rolling, and changed the response from the
.B /CONN
command to be a structured sequence of data records rather than sending
the reply in comments.
.LP
Protocol 325 added
connection debugging support by changing the
.B AUTH
command and adding
.BR /CONN .
.LP
The version 324 protocol added the
.BR DSM ,
.BR OA+ ,
and
.BR OA\-
protocol commands. This version of the protocol also assumes mapper file format
15 is being used.
.LP
Previously, protocol version 323 added support for server-side persistent 
state and the introduction of the
.B SYNC
protocol command.
.LP
Protocol version 322 added comments to version 321.
.LP
Protocol version 321 added authentication support to the 
capabilities of protocol 320.
.LP
Map protocol version 320 has the same commands as 319, but the
.B HEALTH
attribute of creatures changed from map version 12 to 13, so we are advancing the protocol
version at the same time since maps released for protocol 319 were expecting the older map
format.
.LP
Map protocol version 319 differs from version 318 (the first explicitly
numbered version) by the addition of the
.BR CLR@ ,
.BR M? ,
and
.B M@ 
commands.
.SH COPYRIGHT
Part of the GMA software suite, copyright \(co 1992\-2025 by Steven L. Willoughby, Aloha, Oregon, USA. All Rights Reserved. Distributed under BSD-3-Clause License. \"@m(c)@
